# 地图圈选功能使用说明

## 功能概述

地图圈选功能允许用户在地图上绘制一个多边形区域，系统会自动筛选出该区域内的房源或房东。

## 使用方法

### 1. 开启圈选模式

1. 在地图右侧找到圈选工具按钮（笔形图标）
2. 点击按钮进入绘制模式（按钮会变成蓝色）
3. 系统会提示"请在地图上绘制圈选区域"

### 2. 绘制圈选区域

1. 在地图上点击多个点来绘制多边形
2. 双击或点击起点完成绘制
3. 系统会自动：
   - 显示蓝色半透明的圈选区域
   - 筛选区域内的房源/房东
   - 显示筛选结果数量

### 3. 查看筛选结果

- **房东视图**：左侧列表只显示圈选区域内的房东
- **房源视图**：左侧列表只显示圈选区域内的房源
- 地图上只显示符合条件的标记

### 4. 清除圈选

1. 点击红色的清除按钮（X图标）
2. 圈选区域会被移除
3. 列表恢复显示所有数据

## 技术实现

### 核心算法

使用**射线法（Ray Casting Algorithm）**判断点是否在多边形内：

```typescript
function isPointInPolygon(
  point: { lng: number; lat: number },
  polygon: { lng: number; lat: number }[]
): boolean {
  const { lng: x, lat: y } = point;
  let inside = false;

  for (let i = 0, j = polygon.length - 1; i < polygon.length; j = i++) {
    const xi = polygon[i].lng;
    const yi = polygon[i].lat;
    const xj = polygon[j].lng;
    const yj = polygon[j].lat;

    const intersect =
      yi > y !== yj > y && x < ((xj - xi) * (y - yi)) / (yj - yi) + xi;
    if (intersect) inside = !inside;
  }

  return inside;
}
```

### 数据流

1. **用户绘制** → MouseTool 捕获绘制事件
2. **保存坐标** → Store.setSelectedArea(coordinates)
3. **触发筛选** → filteredLandlords / filteredProperties 自动重新计算
4. **更新UI** → 列表和地图同步更新

### 状态管理

在 `propertyStore` 中：

```typescript
// 状态
const selectedArea = ref<{ lng: number; lat: number }[] | null>(null);

// 方法
function setSelectedArea(area: { lng: number; lat: number }[] | null);
function clearSelectedArea();
```

### 筛选逻辑

在 `filteredLandlords` 和 `filteredProperties` 计算属性中：

```typescript
// 地图圈选区域筛选
if (selectedArea.value && selectedArea.value.length >= 3) {
  result = result.filter((item) => {
    if (!item.gps) return false;
    return isPointInPolygon(item.gps, selectedArea.value!);
  });
}
```

## 注意事项

1. **至少需要3个点**才能形成有效的圈选区域
2. **没有GPS信息的房源/房东**不会出现在筛选结果中
3. **圈选区域会保持**，直到用户手动清除或重新绘制
4. **切换视图模式**时，圈选区域仍然有效
5. **与其他筛选条件**可以组合使用（交集）

## 应用场景

- **区域筛选**：只查看某个小区或街道的房源
- **商圈分析**：圈选商圈范围内的所有房源
- **地铁沿线**：圈选地铁站周边的房源
- **避开区域**：先圈选想要的区域，再用其他筛选条件细化

## 未来优化方向

- [ ] 支持矩形圈选（更快捷）
- [ ] 支持圆形圈选（按半径筛选）
- [ ] 保存常用圈选区域
- [ ] 圈选区域命名和管理
- [ ] 导出圈选区域数据
