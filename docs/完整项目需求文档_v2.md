# 租房信息管理系统 - 完整项目需求文档 (v2.0)

**文档日期**: 2025年12月9日
**版本**: 2.0 (整合第二阶段需求)

---

## 1. 项目概述
本项目是一个基于 **Vue 3 + TypeScript + Vite** 的纯前端本地应用，旨在帮助用户高效管理线下“扫楼”采集的租房信息。
核心工作流：**批量拍摄招租广告 -> 批量导入系统 -> 自动提取位置 -> 后期人工补录详情 -> 地图可视化筛选与管理**。
### 1.1 高德地图API Key
// 高德地图配置
const AMAP_KEY = 'e60ae69fab449fe000427408f10e5376';
const AMAP_SECURITY_CODE = 'd3ae266c0437b1a93d309d3f8cf98d86';

### 1.2 主要功能模块
1. **批量导入照片/视频**：
   - 使用 **File System Access API** 直接访问用户本地照片文件夹（无需复制文件）
   - 自动读取 EXIF 信息（GPS、拍摄时间）
   - 保存文件访问句柄，实现持久化访问
2. **自动建档**：导入时自动创建"待完善"房东记录,无需用户即时填写信息。
3. **后期补录**：用户可在空闲时间查看照片，手动录入电话号码、房源详情等信息。
4. **重复数据处理**：
   - 录入电话号码时自动检测重复，支持合并或独立记录
   - GPS 坐标重复时自动微偏移（±0.0001°），避免地图标记重叠
5. **地图可视化**：基于高德地图展示房东位置，支持按类型和状态筛选。
6. **列表视图与筛选**：提供房东列表，支持多维度筛选（微信状态、联系状态、房东类型）。
7. **图片与视频浏览**：通过 Blob URL 实时加载用户本地文件，支持放大、缩放、平移。
8. **数据导出与备份**：支持导出为 Excel 和 JSON 格式，便于数据迁移和备份。

---


## 2. 核心业务流程 (重构)

### 2.1 旧流程 (已废弃)
~~上传单张/多张 -> 立即弹出表单 -> 用户必须填写电话才能保存 -> 存入数据库~~

### 2.2 新流程 (当前需求)
1. **批量采集**：用户在实地拍摄大量招租广告照片（可能包含视频），存放在本地文件夹（如 `D:\租房照片\`）。
2. **首次设置**：
   - 用户点击"选择照片文件夹"，系统弹出目录选择器。
   - 用户选择照片所在文件夹，系统请求持久化访问权限。
   - 系统将 `DirectoryHandle` 保存到 IndexedDB，后续无需重复授权。
3. **批量导入**：
   - 用户点击"扫描文件夹"，系统遍历已授权的目录。
   - 自动读取每个文件的 EXIF 信息（GPS 经纬度、拍摄时间）。
   - **自动建档**：系统立即生成"待完善"的房东记录，无需用户人工干预。
   - 数据库存储**文件名**和**目录标识符**，不存储文件内容。
   - **GPS 去重处理**：如果检测到相同 GPS 坐标，自动进行微小偏移（±0.0001°），避免地图标记重叠。
4. **后期补录**：
   - 用户在空闲时间打开系统。
   - 在列表/地图中点击"待完善"记录。
   - 系统展示高清大图（支持放大/缩小）。
   - 用户肉眼识别图片中的电话、房型等信息，手动录入系统。
4. **数据清洗**：
   - 录入电话时，系统自动检测是否已存在相同电话的房东。
   - 如果存在，提示用户是否合并记录（应对同一房东在多处贴广告的情况）。

---

## 3. 功能需求详情

### 3.1 房东/房源信息管理
#### 3.1.1 房东信息 (Landlord)
需包含以下字段：
- **基础信息**：
  - `id`: 唯一标识
  - `photos`: 照片列表（支持多张，第一张为主图）
  - `phoneNumbers`: **电话号码列表** (支持多个电话，String Array)
  - `landlordType`: **房东类型** (枚举：一手房东、二手房东、中介、其他)
  - `alias`: 备注名/称呼
- **微信/联系状态**：
  - `wechatStatus`: **微信状态** (枚举：未添加、已添加、已拒绝)
  - `contactStatus`: **联系状态** (枚举：未联系、已联系)
  - `wechatNickname`: **微信昵称**
  - `avatar`: **头像** (可上传或使用默认图标)
- **位置信息**：
  - `gps`: 经纬度 (GCJ-02)
  - `address`: 逆地理编码地址
  - `captureTime`: 拍摄时间
- **公共费用标准** (提取自原房源信息)：
  - `depositMethod`: **押金方式** (e.g., 押一付一) 枚举类型，押二付一等
  - `electricity`: 电费单价
  - `water`: 水费单价
  - `internet`: 网费
  - `management`: 管理费
  - `otherFees`: 其他费用

#### 3.1.2 房源信息 (Property/Room)
- `roomType`: 房型 (单间/一房一厅等)
- `rent`: 租金
- `floor`: 楼层
- `orientation`: 朝向
- `appliances`: **家电/家具配置** (多选标签：空调、洗衣机、热水器、冰箱、床、衣柜、宽带等，支持自定义新增)
- `videos`: 视频列表，使用视频上传组件管理
- `notes`: 房源专属备注

### 3.2 地图可视化 (Map Visualization)
#### 3.2.1 标记样式 (Marker)
根据 **房东类型** 显示不同颜色的圆点/图标：
- 🟢 **绿色**：一手房东
- 🔵 **蓝色**：二手房东
- 🔴 **红色**：中介
- ⚪ **灰色**：其他/未知

根据 **联系状态** 调整颜色饱和度/亮度：
- **鲜艳/高亮**：已联系
- **暗沉/灰暗**：未联系

#### 3.2.2 交互
- 点击标记：弹出简要信息卡片（电话、房源数、状态）。
- 点击卡片：打开右侧详情抽屉。

### 3.3 列表与筛选
- **列表项展示**：
  - 显示头像（如有）或默认头像。
  - 显示微信昵称、电话数量。
  - 显示状态标签（房东类型、微信状态）。
- **筛选功能**：
  - 按 **微信状态** 筛选 (未添加/已添加)。
  - 按 **联系状态** 筛选 (未联系/已联系)。
  - 按 **房东类型** 筛选。

### 3.4 图片与媒体浏览
- **本地加载**：解决浏览器安全限制，通过相对路径加载 `photos/` 目录下的资源。
- **图片查看器**：
  - 支持鼠标滚轮缩放。
  - 支持拖拽平移。
  - 支持上一张/下一张切换。
- **视频播放**：点击视频缩略图弹窗播放。

### 3.5 数据导出与备份
- **Excel 导出**：适配新的字段结构（多电话、多状态）。
- **JSON 备份**：完整导出数据库内容，用于数据迁移或备份。

---

## 4. 技术实现要点

### 4.1 本地文件访问与存储
#### 4.1.1 File System Access API (只读模式)
使用现代浏览器的 **File System Access API** 实现用户本地文件夹的持久化访问：

**核心 API**：
- `window.showDirectoryPicker()`: 请求用户授权访问目录（首次使用时）
- `FileSystemDirectoryHandle`: 目录句柄，用于遍历和读取文件
- `FileSystemFileHandle`: 文件句柄，用于获取文件对象
- `handle.getFile()`: 获取 File 对象，可转换为 Blob URL

**实现流程**：
```typescript
// 1. 首次使用：请求目录访问权限（只读模式）
const dirHandle = await window.showDirectoryPicker({
  mode: 'read'
});

// 2. 保存权限句柄到 IndexedDB
await saveDirectoryHandle('userPhotos', dirHandle);

// 3. 扫描文件夹并导入
async function scanAndImport() {
  const dirHandle = await getDirectoryHandle('userPhotos');
  
  for await (const entry of dirHandle.values()) {
    if (entry.kind === 'file' && /\.(jpg|jpeg|png|mp4|mov)$/i.test(entry.name)) {
      const fileHandle = entry;
      const file = await fileHandle.getFile();
      
      // 提取 EXIF
      const exif = await extractEXIF(file);
      
      // 保存文件引用
      await saveToDatabase({
        fileName: entry.name,
        folderId: 'userPhotos',
        gps: exif.gps,
        captureTime: exif.time
      });
    }
  }
}

// 4. 显示图片时，动态生成 Blob URL
async function displayPhoto(fileName: string) {
  const dirHandle = await getDirectoryHandle('userPhotos');
  const fileHandle = await dirHandle.getFileHandle(fileName);
  const file = await fileHandle.getFile();
  const blobUrl = URL.createObjectURL(file);
  
  return blobUrl; // 用于 <img src="..." />
}
```

**浏览器兼容性**：
- ✅ Chrome 86+
- ✅ Edge 86+
- ✅ Opera 72+
- ❌ Firefox（需启用实验性功能）
- ❌ Safari（暂不支持）

**降级方案**：
对于不支持 File System Access API 的浏览器，使用传统文件选择器：
```
1. 点击"选择文件"按钮
2. 使用 <input type="file" multiple> 批量选择照片
3. 系统读取文件内容并转换为 Base64 存储（或提示用户升级浏览器）

注意：降级方案下无法实现持久化访问，每次查看都需重新选择文件。
建议用户使用 Chrome/Edge 以获得最佳体验。
```

#### 4.1.2 文件引用与存储规范
- **用户文件位置**：由用户自由管理（如 `D:\租房照片\`），系统不移动或复制文件
- **数据库存储**：存储文件名（`IMG_001.jpg`）和目录标识（`userPhotos`）
- **前端访问**：通过 `FileSystemFileHandle.getFile()` 读取文件，转换为 Blob URL
- **权限持久化**：`DirectoryHandle` 序列化后存储在 IndexedDB 的专用 Store 中
- **性能优化**：Blob URL 在组件卸载时通过 `URL.revokeObjectURL()` 释放内存

### 4.2 数据库设计 (IndexedDB v3)
需要进行数据迁移，升级 `RentToolsDB` 到版本 3。
- **Store: landlords**
  - 增加索引：`wechatStatus`, `contactStatus`, `landlordType`。

### 4.3 重复数据处理
- **场景**：用户在A巷子拍了照片（电话123），在B巷子又拍了照片（电话123）。
- **逻辑**：
  - 自动建档时：不进行查重（因为此时还没有电话号码，只有GPS）。
  - **人工补录电话时**：监听电话输入框 `blur` 事件。
  - 若发现库中已有该电话：
    - 提示用户：“检测到该电话已存在于 [地址B] 的记录中”。
    - 选项 A：**合并**（将当前照片追加到旧记录，删除当前新记录）。
    - 选项 B：**独立**（确认为不同房东，允许重复）。

### 4.4 GPS 坐标去重与偏移
**问题**：同一地点多张照片会导致地图标记完全重叠，无法点击查看。

**解决方案**：
```typescript
function applyGPSOffset(existingCoords: GPS[], newCoord: GPS): GPS {
  const THRESHOLD = 0.00005; // 约 5 米
  const OFFSET = 0.0001;     // 约 10 米偏移量
  
  // 检查是否与现有坐标过于接近
  const hasDuplicate = existingCoords.some(coord => 
    Math.abs(coord.lng - newCoord.lng) < THRESHOLD &&
    Math.abs(coord.lat - newCoord.lat) < THRESHOLD
  );
  
  if (hasDuplicate) {
    // 随机方向微小偏移
    const angle = Math.random() * 2 * Math.PI;
    return {
      lng: newCoord.lng + Math.cos(angle) * OFFSET,
      lat: newCoord.lat + Math.sin(angle) * OFFSET
    };
  }
  
  return newCoord;
}
```

**效果**：
- 原始坐标：(113.395000, 23.174000)
- 偏移后：(113.395078, 23.174043)
- 地图上视觉距离约 10-15 米，可清晰区分但不影响位置判断

---

## 5. 技术细节补充

### 5.1 File System Access API 权限管理
- **权限持久化**：
  - `DirectoryHandle` 存储在 IndexedDB 的独立 Store (`fileSystemHandles`)
  - 使用浏览器原生序列化机制（Structured Clone）
- **权限验证**：
  - 每次访问前调用 `handle.queryPermission({ mode: 'read' })`
  - 如返回 `'prompt'` 或 `'denied'`，引导用户重新授权
- **多目录支持**：
  - 用户可设置多个文件夹（如"照片文件夹A"、"照片文件夹B"）
  - 每个目录分配唯一 ID，存储在 `{ id: 'folder1', handle: DirectoryHandle }` 结构中

### 5.2 文件扫描与加载优化
- **批量扫描**：使用 `for await...of` 异步迭代器遍历目录，支持大量文件
- **进度显示**：实时更新"已扫描 X / 总数 Y"进度条
- **按需加载**：照片仅在用户查看时才调用 `getFile()` 生成 Blob URL，避免内存占用
- **缓存策略**：已生成的 Blob URL 临时缓存（使用 Map），切换照片时复用
- **错误处理**：
  - 文件被删除/移动：提示"文件不存在，请重新扫描"
  - 权限被撤销：引导用户重新授权
  - 无 EXIF 数据：记录为"位置未知"，允许手动输入坐标

### 5.3 数据库设计补充
**IndexedDB Stores**：
1. **landlords**（房东信息）：主要数据存储
2. **fileSystemHandles**（文件系统句柄）：
   ```typescript
   {
     id: 'userPhotosFolder',
     handle: DirectoryHandle, // 序列化后的句柄
     displayPath: 'D:\\租房照片', // 用户友好的路径显示
     lastAccess: Date
   }
   ```

### 5.4 待确认事项
1. **头像管理**：头像可以是照片文件夹中的任意图片，用户在详情页选择关联即可
2. **OCR 功能**：当前需求为"肉眼识别手动填写"，暂不集成 OCR

---

## 6. 未来功能扩展计划

### 6.1 近期可实现功能（优先级高）

#### 📸 多照片管理
**当前限制**：每个房东仅支持一张主照片  
**改进方向**：
- [ ] 支持每个房东关联多张照片（同一房东在不同地点的广告）
- [ ] 照片画廊浏览（网格布局 + 轮播查看）
- [ ] 照片与房源关联（为每个房源单独上传内景照片）
- [ ] 照片备注功能（标记照片拍摄位置或特殊说明）

**数据结构调整**：
```typescript
// 将 photoPath: string 改为
photos: Array<{
  id: string;
  fileName: string;
  folderId: string;
  captureTime: string;
  gps?: GPS;
  roomId?: string;  // 可选：关联到具体房源
  notes?: string;
}>
```

#### 🎥 视频功能完善
**当前状态**：房源支持单个 `videoPath` 字段  
**改进方向**：
- [ ] HTML5 视频播放器（支持暂停、快进、音量控制）
- [ ] 视频缩略图自动生成（Canvas 截取第一帧）
- [ ] 多视频支持（一个房源可上传多个看房视频）
- [ ] 视频时长提取（通过 Video 元素 `loadedmetadata` 事件）

**实现示例**：
```vue
<video 
  v-for="video in room.videos" 
  :src="getBlobUrl(video.fileName)" 
  controls 
  width="100%" 
  @loadedmetadata="extractDuration"
></video>
```

#### 🗺️ 地图功能增强
- [ ] **标记聚合**：房东密集区域自动聚合，点击展开查看列表
  - 使用高德 `AMap.MarkerCluster` 插件
- [ ] **高级筛选**：
  - 按租金区间筛选（如 800-1200 元）
  - 按房型筛选（单间/一房一厅）
  - 按可租状态筛选
- [ ] **热力图模式**：可视化房源密度分布
- [ ] **距离测量**：测量两个房东之间的直线距离

#### 📊 数据分析仪表盘
- [ ] **统计卡片**：
  - 总房东数 / 总房源数
  - 已联系 / 未联系比例
  - 平均租金 / 最低/最高租金
- [ ] **图表可视化**（集成 ECharts）：
  - 房型分布饼图
  - 租金分布柱状图
  - 新增房东时间线趋势图
- [ ] **价格分析**：
  - 各房型平均价格对比
  - 性价比排序（租金/房型面积）

#### ⚡ 批量操作优化
- [ ] **批量编辑**：同时修改多个房东的公共费用标准
- [ ] **批量删除**：勾选多个房东后一键删除
- [ ] **批量导出**：选择部分房东导出（而非全部）
- [ ] **导入 Excel**：支持逆向导入（从 Excel 批量录入数据）

---

### 6.2 中期规划功能（优先级中）

#### 🏷️ 标签系统
- [ ] 为房东/房源添加自定义标签（如"急租"、"可短租"、"宠物友好"）
- [ ] 按标签筛选和分组
- [ ] 标签统计（显示每个标签的房源数量）

#### 🔍 智能搜索
- [ ] 全文搜索（电话、地址、备注）
- [ ] 模糊匹配（容错输入）
- [ ] 搜索历史记录

#### 📱 移动端优化
- [ ] 响应式布局适配（适配手机/平板屏幕）
- [ ] PWA 支持（添加到主屏幕、离线可用）
- [ ] 触摸手势支持（滑动切换照片、双指缩放地图）

#### 🔔 提醒功能
- [ ] 待联系提醒（超过 N 天未联系的房东）
- [ ] 房源到期提醒（可租状态维护）
- [ ] 数据备份提醒（每周/每月提醒备份）

---

### 6.3 长期展望功能（优先级低）

#### 🤖 智能推荐
基于用户偏好推荐合适房源：
- 价格匹配度（30%）
- 房型匹配度（25%）
- 位置便利性（20%）
- 房东响应速度（15%）
- 综合性价比（10%）

#### 👥 协同工作
支持多人共同扫楼：
- 数据云端同步（Firebase / Supabase）
- 任务分配（区域划分）
- 冲突处理（合并重复录入）

#### 🧠 AI 辅助
- 智能地址补全（基于历史数据）
- 重复检测（基于电话/GPS 相似度自动识别重复房东）
- 云端 OCR（接入腾讯/百度 OCR API 提升识别率）

---

## 7. 数据质量保障

### 7.1 拍照规范
- ✅ **使用原生相机 APP**：保留完整 EXIF 信息
- ❌ **避免微信/QQ 传输**：会清除 GPS 数据
- ✅ **推荐传输方式**：
  - AirDrop（iOS/Mac）
  - 数据线直连
  - 云盘原图上传（OneDrive/iCloud）

### 7.2 数据录入规范
- 及时录入（当天扫楼当天录入，避免遗忘）
- 验证 GPS 坐标（在地图上检查位置是否正确）
- 规范电话格式（统一 11 位手机号，不含空格和横线）
- 完善房源信息（至少填写房型和租金）

### 7.3 数据维护规范
- **定期备份**：每周导出 JSON 备份文件
- **及时更新**：房源已租后立即标记为"不可租"
- **补充记录**：每次联系房东后更新沟通记录

---

## 8. 已知问题与限制

### 8.1 File System Access API 兼容性
**支持情况**：
- ✅ Chrome 86+
- ✅ Edge 86+
- ✅ Opera 72+
- ❌ Firefox（需手动启用实验性功能）
- ❌ Safari（暂不支持）

**影响**：约 30% 用户可能无法使用文件夹持久化访问功能  
**降级方案**：提供传统文件选择器 + Base64 存储模式

### 8.2 文件访问权限限制
**问题**：用户撤销权限或文件被移动后，系统无法访问照片  
**临时方案**：显示"文件不可用"提示，引导用户重新授权或重新扫描  
**未来改进**：提供"文件路径修复"工具，批量更新失效路径

### 8.3 地图 API 限额
**高德地图个人开发者限额**：
- 每日调用量：30 万次
- 每秒并发：300 次

**应对策略**：
- 缓存已转换的地址，避免重复调用
- 批量导入时增加节流延迟（每次间隔 100ms）

### 8.4 IndexedDB 存储限制
**浏览器配额**：通常为磁盘可用空间的 50%，但单个源限制约 50MB-2GB（因浏览器而异）  
**影响**：大量照片路径存储不会超限，但降级方案的 Base64 模式可能触发限制  
**建议**：优先使用 File System Access API 模式

---

## 9. 项目结构

```
rent-tools/
├── docs/
│   ├── 完整项目需求文档_v2.md    # 本文档
│   ├── 开发计划_第二阶段_v2.md   # 开发任务清单
│   └── 开发历程总结.md           # 历史文档
├── public/                       # 静态资源（不使用，文件在用户本地）
├── src/
│   ├── components/
│   │   ├── PhotoUpload.vue       # 文件夹选择 + 批量扫描
│   │   ├── MapView.vue           # 高德地图展示
│   │   └── PropertyDetail.vue    # 房东详情抽屉
│   ├── stores/
│   │   └── property.ts           # Pinia 状态管理
│   ├── types/
│   │   └── index.ts              # TypeScript 类型定义
│   ├── utils/
│   │   ├── exif.ts               # EXIF 提取 + 坐标转换
│   │   ├── geocode.ts            # 逆地理编码
│   │   ├── storage.ts            # IndexedDB 操作
│   │   ├── export.ts             # Excel/JSON 导出
│   │   └── fileSystem.ts         # File System Access API 封装
│   ├── App.vue                   # 主应用布局
│   └── main.ts                   # 入口文件
├── index.html
├── package.json
├── vite.config.ts
└── README.md
```

---

## 10. 技术栈

| 分类 | 技术 | 版本 | 用途 |
|------|------|------|------|
| 框架 | Vue 3 | 3.4+ | 响应式 UI 框架 |
| 语言 | TypeScript | 5.x | 类型安全 |
| 构建 | Vite | 5.x | 开发服务器 + 构建工具 |
| UI 库 | Element Plus | 最新 | 组件库 |
| 地图 | 高德地图 JS API | v2.0 | 地图展示、逆地理编码 |
| 状态 | Pinia | 最新 | 全局状态管理 |
| 存储 | IndexedDB | 原生 API | 本地数据持久化 |
| EXIF | exifr | 最新 | GPS/时间提取 |
| 导出 | xlsx | 最新 | Excel 文件生成 |
| 文件访问 | File System Access API | 原生 API | 持久化文件夹访问 |

---

## 11. 快速上手指南（给开发者）

### 11.1 阅读顺序
1. 本文档（完整需求）
2. `src/types/index.ts`（数据结构）
3. `src/stores/property.ts`（状态管理逻辑）
4. `src/components/PhotoUpload.vue`（核心导入流程）

### 11.2 关键代码位置
- **文件夹访问**：`src/utils/fileSystem.ts`
- **EXIF 提取**：`src/utils/exif.ts`
- **地图初始化**：`src/components/MapView.vue` 的 `onMounted`
- **数据持久化**：`src/utils/storage.ts`

### 11.3 调试技巧
```javascript
// 浏览器控制台查看 IndexedDB
indexedDB.databases().then(console.log);

// 查看 Pinia store 状态
import { usePropertyStore } from '@/stores/property';
const store = usePropertyStore();
console.log(store.landlords);

// 测试文件访问
const dirHandle = await window.showDirectoryPicker();
for await (const entry of dirHandle.values()) {
  console.log(entry.name);
}
```

---

## 12. 常见问题（FAQ）

**Q1: 为什么不把照片复制到项目目录？**  
A: 避免文件重复占用空间，用户可以继续用其他软件管理照片。

**Q2: 文件夹权限会过期吗？**  
A: 浏览器重启后权限仍然有效（已序列化存储），除非用户手动撤销。

**Q3: 不支持的浏览器怎么办？**  
A: 系统会自动降级到传统文件选择器模式，但每次查看都需重新选择文件。

**Q4: 可以同时管理多个文件夹吗？**  
A: 可以，系统支持保存多个文件夹的访问权限。

**Q5: 数据会丢失吗？**  
A: IndexedDB 数据持久化存储，除非用户清除浏览器数据或手动删除。建议定期导出备份。

