# 房源浏览功能设计文档

**文档日期**: 2025年12月11日  
**版本**: 1.1  
**状态**: 设计阶段  
**最后更新**: 2025年12月11日 - 优化详情页布局与交互

---

## 1. 需求背景

### 1.1 当前问题
目前系统已实现房东信息的浏览和管理，但存在以下痛点：
1. **房东 → 房源的层级不清晰**：一个房东下可能有多套房源（单间、一房一厅、两房一厅等），但在房东列表中无法快速预览
2. **房源信息难以快速浏览**：需要点击进入房东详情，再逐个查看房源，效率低下
3. **缺少房源级别的管理入口**：无法快速筛选"所有单间"、"租金1000-1500的房源"等
4. **信息展示不够直观**：房源的关键信息（房型、租金、配套设施、公共费用）分散在多个位置
5. **视频浏览不便**：房源主要以视频记录，但缺乏高效的视频浏览和信息整理界面

### 1.2 核心诉求
> **"我录入了很多房子后如何快速进行浏览已有房源呢？"**

用户需要：
- ✅ **快速概览所有房源**：一眼看到房型、租金、地址等核心信息
- ✅ **视频优先浏览**：房源以视频为主要记录方式，需要便捷的视频播放和切换
- ✅ **查看完整信息**：包括基本信息（房型、租金、楼层）+ 房东公共费用（水电费、押金方式）
- ✅ **快速整理能力**：类似"一边看视频一边整理"的工作流，发现问题立即修改，无需多次点击
- ✅ **多维度筛选**：按房型、租金区间、配套设施快速筛选

---

## 2. 设计方案

### 2.1 整体架构

#### 2.1.1 三级信息层次
```
房东 (Landlord)
├── 基础信息：电话、类型、微信状态
├── 公共费用：水电费、押金方式、网费等
└── 房源列表 (Properties)
    ├── 房源1：单间、1200元/月
    ├── 房源2：一房一厅、1800元/月
    └── 房源3：...
```

**关键点**：
- 公共费用是"房东级别"的信息，所有房源共享
- 房源信息是"房源级别"的信息，每套房源独立

#### 2.1.2 视图模式设计
提供 **左右分栏布局 + 顶部切换** 的交互模式：

```
┌──────────────────────────────────────────────────────┐
│  Toolbar：[ 房东视图 | 房源视图 ]   [筛选] [导出]     │
├───────────────────┬──────────────────────────────────┤
│  左侧列表区域      │  右侧地图区域                     │
│  ┌─────────────┐  │  ┌────────────────────────────┐  │
│  │ 房东/房源    │  │  │                            │  │
│  │ 列表组件     │  │  │    高德地图                │  │
│  │ (可切换)     │  │  │    - 标记显示               │  │
│  │             │  │  │    - InfoWindow             │  │
│  └─────────────┘  │  │                            │  │
│                   │  └────────────────────────────┘  │
└───────────────────┴──────────────────────────────────┘
```

**布局特点**：
- **左侧（30-40%）**：列表区域，根据 Toolbar 切换显示房东列表或房源列表
- **右侧（60-70%）**：固定显示高德地图，地图内容随列表切换而变化
- **顶部 Toolbar**：`[ 房东视图 | 房源视图 ]` 切换按钮组

| 视图模式 | 左侧列表显示 | 右侧地图显示 | 交互联动 |
|---------|------------|------------|---------|
| **房东视图** | 房东列表组件 | 房东位置标记（圆点） | 点击列表 → 地图定位 → 打开房东 InfoWindow |
| **房源视图** | 房源列表组件 | 房源位置标记（数字徽章） | 点击列表 → 地图定位 → 打开房源 InfoWindow（视频缩略图）|

---

### 2.2 房源视图详细设计

#### 2.2.1 整体布局（左右分栏）

```
┌──────────────────────────────────────────────────────────────┐
│  Toolbar: [房东视图] [✓ 房源视图]  [筛选▼] [导出]            │
├──────────────────────┬───────────────────────────────────────┤
│  房源列表（左侧）     │  地图视图（右侧）                      │
│  ┌────────────────┐  │  ┌─────────────────────────────────┐  │
│  │ 筛选栏         │  │  │                                 │  │
│  │ [房型▼][租金▼] │  │  │  ⭕(3) 标记：房源数量徽章      │  │
│  └────────────────┘  │  │                                 │  │
│  ┌────────────────┐  │  │  InfoWindow（点击标记显示）：    │  │
│  │ 房源卡片1       │  │  │  ┌───────────────────────────┐ │  │
│  │ 🎬视频缩略图    │  │  │  │ 房源1 [视频缩略图]         │ │  │
│  │ 单间·1200元    │  │  │  │ 房源2 [视频缩略图]         │ │  │
│  │ [定位🗺️]       │  │  │  │ 房源3 [视频缩略图]         │ │  │
│  └────────────────┘  │  │  └───────────────────────────┘ │  │
│  ┌────────────────┐  │  │                                 │  │
│  │ 房源卡片2       │  │  │  点击缩略图 → 打开房源详情页     │  │
│  └────────────────┘  │  └─────────────────────────────────┘  │
│  ...                │                                         │
└──────────────────────┴───────────────────────────────────────┘
```

**左侧房源列表（30-40%宽度）**：
- 筛选栏（可折叠）
- 房源卡片垂直滚动列表
- 每张卡片包含：视频缩略图、基本信息、定位按钮

#### 2.2.2 房源卡片设计（左侧列表）

**卡片样式**（垂直列表，单列布局）

```
┌─────────────────────────────────────────┐
│  🎬 [视频缩略图/首帧]                    │
│       ▶️ 点击打开详情页                  │
├─────────────────────────────────────────┤
│  🏠 两房一厅 · 3楼                       │
│  💰 ¥1800 / 月                          │
│  📍 天河区XX路XX号（点击查看房东详情）    │
│  ─────────────────────────────────      │
│  ✓ 空调  ✓ 洗衣机  ✓ 热水器  ✓ 冰箱     │
│  ─────────────────────────────────      │
│  💧 水费: 民用水  ⚡ 电费: 0.88元/度     │
│  🏦 押金: 押一付一                       │
│  📞 房东: 138****8888 (一手房东)        │
│  ─────────────────────────────────      │
│  [ 查看详情 ]        [ 定位🗺️ ]        │
└─────────────────────────────────────────┘
```

**交互说明**：
- **点击视频缩略图**：打开房源详情页（左右分栏，左侧视频右侧表单）
- **点击"定位🗺️"按钮**：
  1. 右侧地图自动定位到该房源的 GPS 坐标
  2. 自动打开该位置的 InfoWindow
  3. InfoWindow 中显示该位置所有房源的视频缩略图列表

**字段说明**：

| 区域 | 字段来源 | 说明 |
|-----|---------|------|
| **房源基本信息** | `Property` | 房型、租金、楼层、配套设施 |
| **公共费用** | `Landlord.commonFees` | 水电费、押金（从房东信息继承） |
| **房东信息** | `Landlord` | 电话、房东类型（快速了解背景） |
| **视频** | `Property.videos[0]` | **优先使用房源视频缩略图**（房源主要以视频记录） |
| **照片降级** | `Landlord.photos[0]` | 若无视频，则使用房东主图 |

#### 2.2.3 地图标记设计（房源视图模式）

**标记样式**：使用数字徽章显示该位置的房源数量

```
地图标记示例：

⭕ 3    ← 该位置有 3 套房源
⭕ 1    ← 该位置有 1 套房源
⭕ 5    ← 该位置有 5 套房源
```

**标记颜色规则**（根据房源状态）：
- 🟢 **绿色徽章**：所有房源都可租
- 🔵 **蓝色徽章**：部分房源可租
- ⚪ **灰色徽章**：所有房源已租出

**InfoWindow 内容**（点击标记时弹出）：

```
┌─────────────────────────────────────┐
│  天河区XX路XX号（共3套房源）          │
├─────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐   │
│  │ 🎬视频缩略图  │  │ 🎬视频缩略图  │   │
│  │ 单间·1200元  │  │ 一房·1800元  │   │
│  │ [查看详情]   │  │ [查看详情]   │   │
│  └─────────────┘  └─────────────┘   │
│  ┌─────────────┐                    │
│  │ 🎬视频缩略图  │                    │
│  │ 两房·2500元  │                    │
│  │ [查看详情]   │                    │
│  └─────────────┘                    │
├─────────────────────────────────────┤
│  📞 房东: 138****8888 (一手房东)     │
│  [ 查看房东详情 ]                    │
└─────────────────────────────────────┘
```

**交互逻辑**：
1. **点击地图标记** → 打开 InfoWindow，显示该位置所有房源的视频缩略图
2. **点击视频缩略图** → 打开对应房源的详情页（左视频右表单）
3. **点击"查看房东详情"** → 跳转到房东视图，自动定位到该房东

#### 2.2.4 筛选器设计

**筛选维度**：

```typescript
interface PropertyFilterOptions {
  // 房源维度
  roomTypes?: string[];           // 房型：单间、一房一厅等
  rentRange?: [number, number];   // 租金区间：[1000, 2000]
  amenities?: string[];           // 配套设施：空调、洗衣机等
  floor?: string;                 // 楼层：低楼层(<3)、中楼层(3-7)、高楼层(>7)
  available?: boolean;            // 是否可租
  
  // 房东维度（关联筛选）
  landlordType?: LandlordType[];  // 房东类型
  depositMethod?: string[];       // 押金方式
  waterType?: string;             // 水费类型
  electricityType?: string;       // 电费类型
  
  // 搜索
  keyword?: string;               // 关键词搜索（地址、备注）
}
```

**筛选器UI**（位于左侧列表顶部）：

```
┌─────────────────────────────────────┐
│ 房型：[x] 单间  [x] 一房一厅  ...    │
│ 租金：[1000] - [2000]  元/月        │
│ 配套：[x] 空调  [ ] 洗衣机  ...     │
│ 关键词：[____________]  🔍          │
│ [ 重置 ]           [ 应用 (35条) ]  │
└─────────────────────────────────────┘
```

**筛选效果**：
- 左侧列表实时更新，只显示符合条件的房源
- 右侧地图标记同步更新，只显示符合条件的位置

#### 2.2.5 交互流程

**场景1：切换到房源视图**
```
用户点击顶部 Toolbar "房源视图"
      ↓
左侧：房东列表组件卸载 → 房源列表组件挂载
右侧：地图标记更新为数字徽章（显示房源数量）
      ↓
用户在左侧浏览房源卡片（滚动列表）
右侧地图显示所有房源位置标记
```

**场景2：列表定位到地图**
```
用户点击房源卡片的"定位🗺️"按钮
      ↓
右侧地图自动定位到该房源的 GPS 坐标
地图缩放到合适级别（如 zoom=16）
      ↓
自动打开该位置的 InfoWindow
显示该位置所有房源的视频缩略图
      ↓
卡片高亮显示（或添加边框动画）
```

**场景3：地图标记到详情页**
```
用户点击地图上的数字徽章标记
      ↓
打开 InfoWindow，显示该位置所有房源的视频缩略图
      ↓
用户点击某个房源的视频缩略图
      ↓
打开该房源的详情页（全屏对话框）
左侧：视频播放器
右侧：表单式信息展示（直接可编辑）
      ↓
用户一边看视频一边修改信息
点击底部"保存"按钮
      ↓
更新数据库（房源+房东） → 关闭详情页 → 提示"保存成功"
```

**场景4：筛选联动**
```
用户在左侧筛选栏选择条件
（如：房型=单间、租金=1000-1500）
      ↓
点击"应用筛选"
      ↓
左侧：列表只显示符合条件的房源
右侧：地图标记同步更新，只显示符合条件的位置
      ↓
标记数字也会更新（如原来是3，筛选后变成1）
```

**场景5：查看房东详情**
```
用户点击房源卡片中的房东电话
      ↓
顶部 Toolbar 自动切换到"房东视图"
左侧：房源列表卸载 → 房东列表挂载
右侧：地图标记更新为房东位置（圆点）
      ↓
自动定位到该房东，打开房东详情抽屉
```

---

### 2.3 数据结构调整

#### 2.3.1 当前数据结构回顾

```typescript
interface Landlord {
  id: string;
  phoneNumbers: string[];
  landlordType: LandlordType;
  
  // 公共费用（房东级别）
  commonFees: {
    electricity: { type: string; price?: number };
    water: { type: string; price?: number };
    internet?: number;
    management?: number;
    garbage?: number;
  };
  deposit: string; // 押金方式
  
  // 房源列表（房源级别）
  properties: RoomInfo[];
  
  // 其他字段...
}

interface RoomInfo {
  id: string;
  roomType: string;     // 房型
  rent?: number;        // 租金
  floor?: string;       // 楼层
  description?: string; // 描述
  amenities: string[];  // 配套设施
  videos: Video[];      // 视频
  available?: boolean;  // 是否可租
}
```

#### 2.3.2 需要新增的字段

**无需修改数据结构！** 当前设计已满足需求。只需在视图层处理：

```typescript
// 房源视图的数据转换函数
function transformToPropertyView(landlords: Landlord[]): PropertyViewItem[] {
  const items: PropertyViewItem[] = [];
  
  landlords.forEach(landlord => {
    landlord.properties.forEach(property => {
      items.push({
        // 房源信息
        propertyId: property.id,
        roomType: property.roomType,
        rent: property.rent,
        floor: property.floor,
        amenities: property.amenities,
        available: property.available,
        
        // 从房东继承的信息
        landlordId: landlord.id,
        landlordPhone: landlord.phoneNumbers[0],
        landlordType: landlord.landlordType,
        address: landlord.address,
        gps: landlord.gps,
        
        // 公共费用（从房东继承）
        water: landlord.commonFees.water,
        electricity: landlord.commonFees.electricity,
        deposit: landlord.deposit,
        
        // 照片（使用房东主图）
        photo: landlord.photos[0],
      });
    });
  });
  
  return items;
}
```

---

### 2.4 技术实现要点

#### 2.4.1 性能优化

**问题**：假设有100个房东，每个房东平均3套房源 = 300条数据，全部渲染会卡顿

**解决方案**：
1. **虚拟滚动**（已有）：复用 `RecycleScroller` 组件
2. **分页加载**：每页20条，懒加载
3. **图片懒加载**：使用 `IntersectionObserver` 监听卡片可见性

```vue
<!-- 使用 Element Plus 的无限滚动 -->
<el-scrollbar 
  v-infinite-scroll="loadMore"
  :infinite-scroll-distance="200">
  <div class="property-grid">
    <PropertyCard 
      v-for="item in displayedProperties"
      :key="item.propertyId"
      :data="item" />
  </div>
</el-scrollbar>
```

#### 2.4.2 状态管理

在 `propertyStore` 新增：

```typescript
// stores/property.ts
export const usePropertyStore = defineStore('property', () => {
  // 新增：房源视图相关状态
  const propertyViewMode = ref<'landlord' | 'property' | 'map'>('landlord');
  const propertyFilters = ref<PropertyFilterOptions>({});
  
  // 计算属性：扁平化的房源列表
  const flattenedProperties = computed(() => {
    return transformToPropertyView(landlords.value);
  });
  
  // 计算属性：筛选后的房源列表
  const filteredProperties = computed(() => {
    let result = flattenedProperties.value;
    
    // 应用筛选逻辑
    if (propertyFilters.value.roomTypes?.length) {
      result = result.filter(p => 
        propertyFilters.value.roomTypes!.includes(p.roomType)
      );
    }
    
    if (propertyFilters.value.rentRange) {
      const [min, max] = propertyFilters.value.rentRange;
      result = result.filter(p => 
        p.rent && p.rent >= min && p.rent <= max
      );
    }
    
    // ... 其他筛选条件
    
    return result;
  });
  
  return {
    propertyViewMode,
    propertyFilters,
    flattenedProperties,
    filteredProperties,
  };
});
```

#### 2.4.3 组件结构

```
src/
├── views/
│   ├── MainView.vue             # 主视图（左右分栏布局 + Toolbar）
│   └── PropertyDetailPage.vue   # 房源详情页（左视频右表单）
├── components/
│   ├── LandlordList.vue         # 房东列表组件（抽离自当前 App.vue）
│   ├── PropertyList.vue         # 房源列表组件（新增）
│   ├── PropertyCard.vue         # 房源卡片组件
│   ├── PropertyFilter.vue       # 房源筛选器组件
│   ├── MapView.vue              # 地图组件（已有，需增强）
│   ├── VideoPlayer.vue          # 视频播放器组件（支持多视频切换）
│   └── PropertyInfoWindow.vue   # 房源 InfoWindow 组件（地图标记弹窗）
```

**MainView.vue 主视图结构**：

```vue
<template>
  <div class="main-view">
    <!-- 顶部 Toolbar -->
    <div class="toolbar">
      <el-radio-group v-model="viewMode">
        <el-radio-button label="landlord">房东视图</el-radio-button>
        <el-radio-button label="property">房源视图</el-radio-button>
      </el-radio-group>
      <el-button icon="Filter" @click="showFilter">筛选</el-button>
      <el-button icon="Download" @click="exportData">导出</el-button>
    </div>
    
    <!-- 左右分栏 -->
    <div class="split-view">
      <!-- 左侧：列表区域（根据 viewMode 切换组件） -->
      <div class="list-panel">
        <LandlordList v-if="viewMode === 'landlord'" />
        <PropertyList v-else-if="viewMode === 'property'" />
      </div>
      
      <!-- 右侧：地图区域（固定显示，内容根据 viewMode 变化） -->
      <div class="map-panel">
        <MapView 
          :view-mode="viewMode"
          :data="currentData"
          @marker-click="handleMarkerClick"
          @info-window-item-click="handleInfoWindowItemClick" />
      </div>
    </div>
  </div>
</template>
```

**组件职责说明**：

| 组件 | 职责 | 数据来源 |
|-----|------|---------|
| **MainView.vue** | 主布局，管理视图切换状态 | Store (viewMode) |
| **LandlordList.vue** | 显示房东列表，从 App.vue 抽离 | Store (filteredLandlords) |
| **PropertyList.vue** | 显示房源列表（新增） | Store (flattenedProperties) |
| **MapView.vue** | 显示地图和标记，根据 viewMode 渲染不同标记 | Props (viewMode, data) |
| **PropertyInfoWindow.vue** | 房源 InfoWindow 内容（视频缩略图列表） | Props (properties) |

#### 2.4.4 房源详情页设计（核心功能）

**布局结构**（全屏对话框或独立路由页面）

```
┌────────────────────────────────────────────────────────────┐
│  房源详情 - 两房一厅 · 天河区XX路XX号          [ × 关闭 ]    │
├─────────────────────┬──────────────────────────────────────┤
│                     │  🏠 房源基本信息                       │
│                     │  ├─ 房型: [两房一厅 ▼]                │
│   📹 视频播放器      │  ├─ 租金: [1800] 元/月                │
│   ┌───────────────┐ │  ├─ 楼层: [3楼]                       │
│   │               │ │  └─ 是否可租: [ √ ] 可租              │
│   │   视频内容     │ │                                       │
│   │               │ │  🛋️ 配套设施                          │
│   │               │ │  [x] 空调  [x] 洗衣机  [ ] 冰箱       │
│   └───────────────┘ │  [x] 热水器  [ ] 宽带  更多...        │
│                     │                                       │
│   [ 上一个 | 下一个 ]│  💰 公共费用（修改会同步到房东）       │
│   视频列表：        │  ├─ 水费: [民用水 ▼] [5.0] 元/吨     │
│   [1] [2] [3]       │  ├─ 电费: [0.88 ▼] [0.88] 元/度      │
│                     │  ├─ 网费: [100] 元/月                │
│                     │  ├─ 管理费: [50] 元/月               │
│                     │  └─ 押金: [押一付一 ▼]               │
│                     │                                       │
│                     │  📝 房源备注                          │
│                     │  [文本域输入框...]                    │
│                     │                                       │
│                     │  📞 房东信息（只读，可点击跳转）       │
│                     │  电话: 138****8888                    │
│                     │  类型: 一手房东                       │
│                     │  地址: 天河区XX路XX号                 │
├─────────────────────┴──────────────────────────────────────┤
│  [ 取消 ]                                      [ 保存修改 ] │
└────────────────────────────────────────────────────────────┘
```

**关键特性**：

1. **左右分栏布局**（左40%，右60%）
   - **左侧**：视频播放器 + 视频列表切换
   - **右侧**：表单式信息展示，所有字段直接可编辑

2. **视频播放器功能**
   - 支持播放/暂停、进度条、音量控制
   - 支持全屏播放
   - 底部视频列表缩略图，点击快速切换
   - 键盘快捷键：← → 切换视频，空格 播放/暂停

3. **表单直接编辑模式**（无需点击"编辑"按钮）
   - 所有输入框、下拉框、多选框始终处于可编辑状态
   - 实时表单验证（租金必须为正数、房型必选等）
   - 修改后字段高亮显示（黄色背景提示未保存）

4. **公共费用同步逻辑**
   - 用户修改水费/电费/押金时，显示提示：
     ```
     ⚠️ 提示：修改公共费用会同步到房东信息，影响该房东下的所有房源
     [ 仅修改当前房源 ] [ 同步到房东（推荐） ]
     ```
   - 默认选中"同步到房东"，更新 `Landlord.commonFees`
   - 若选择"仅修改当前房源"，需扩展数据结构（房源级别的费用覆盖）

5. **底部保存按钮**
   - 未修改时：按钮禁用状态
   - 有修改时：按钮高亮，显示"保存修改"
   - 保存逻辑：同时更新房源信息 + 房东公共费用（如有修改）

**MapView.vue 增强说明**：

```vue
<template>
  <div class="map-container">
    <div id="amap-container"></div>
  </div>
</template>

<script setup lang="ts">
import { computed, watch } from 'vue';

const props = defineProps<{
  viewMode: 'landlord' | 'property';
  data: Landlord[] | PropertyViewItem[];
}>();

const emit = defineEmits<{
  markerClick: [id: string];
  infoWindowItemClick: [propertyId: string];
}>();

// 根据 viewMode 渲染不同标记
watch(() => props.viewMode, (mode) => {
  clearMarkers();
  
  if (mode === 'landlord') {
    renderLandlordMarkers(); // 渲染圆点标记
  } else {
    renderPropertyMarkers(); // 渲染数字徽章标记
  }
});

// 渲染房源标记（数字徽章）
function renderPropertyMarkers() {
  // 按 GPS 分组房源
  const groupedByGps = groupPropertiesByGps(props.data);
  
  groupedByGps.forEach(({ gps, properties }) => {
    const marker = new AMap.Marker({
      position: [gps.lng, gps.lat],
      content: createBadgeMarker(properties.length, getStatusColor(properties)),
      extData: { type: 'property', properties }
    });
    
    marker.on('click', () => {
      showPropertyInfoWindow(marker, properties);
    });
    
    map.add(marker);
  });
}

// 创建数字徽章标记
function createBadgeMarker(count: number, color: string) {
  return `
    <div class="property-marker" style="background: ${color}">
      <span class="count">${count}</span>
    </div>
  `;
}

// 显示房源 InfoWindow
function showPropertyInfoWindow(marker, properties) {
  const content = `
    <div class="property-info-window">
      <h4>${properties[0].address}（共${properties.length}套房源）</h4>
      <div class="property-grid">
        ${properties.map(p => `
          <div class="property-item" onclick="handlePropertyClick('${p.id}')">
            <video class="thumbnail" src="${p.videos[0]?.url}" poster="${p.videos[0]?.poster}"></video>
            <div class="info">
              <span>${p.roomType}·${p.rent}元</span>
              <button>查看详情</button>
            </div>
          </div>
        `).join('')}
      </div>
    </div>
  `;
  
  infoWindow.setContent(content);
  infoWindow.open(map, marker.getPosition());
}

// 定位到指定标记并打开 InfoWindow
function locateToMarker(gps: GPS) {
  map.setZoomAndCenter(16, [gps.lng, gps.lat]);
  
  // 找到对应标记并触发点击
  const marker = findMarkerByGps(gps);
  if (marker) {
    AMap.event.trigger(marker, 'click');
  }
}

defineExpose({ locateToMarker }); // 暴露给父组件调用
</script>
```

**PropertyList.vue 示例**：

```vue
<template>
  <div class="property-list">
    <!-- 筛选栏 -->
    <PropertyFilter v-model="filters" />
    
    <!-- 房源卡片列表 -->
    <el-scrollbar class="list-scrollbar">
      <PropertyCard 
        v-for="item in filteredProperties"
        :key="item.propertyId"
        :data="item"
        @view-detail="handleViewDetail"
        @locate="handleLocate"
        @view-landlord="handleViewLandlord" />
    </el-scrollbar>
    
    <!-- 统计信息 -->
    <div class="list-footer">
      共 {{ filteredProperties.length }} 套房源
    </div>
  </div>
</template>

<script setup lang="ts">
import { computed, inject } from 'vue';
import { usePropertyStore } from '@/stores/property';

const propertyStore = usePropertyStore();
const mapViewRef = inject('mapViewRef'); // 获取地图组件引用

const filteredProperties = computed(() => propertyStore.filteredProperties);

// 查看详情
const handleViewDetail = (propertyId: string) => {
  // 打开房源详情页（全屏对话框）
  openPropertyDetailDialog(propertyId);
};

// 定位到地图
const handleLocate = (gps: GPS) => {
  // 调用地图组件的定位方法
  mapViewRef.value?.locateToMarker(gps);
};

// 查看房东详情
const handleViewLandlord = (landlordId: string) => {
  propertyStore.viewMode = 'landlord';
  propertyStore.focusedLandlordId = landlordId;
};
</script>
```

**PropertyCard.vue 示例**：

```vue
<template>
  <el-card class="property-card" shadow="hover">
    <!-- 视频缩略图 -->
    <div class="card-video" @click="viewDetail">
      <video 
        :src="videoUrl" 
        :poster="videoPoster"
        class="video-thumbnail"
        @mouseenter="playPreview"
        @mouseleave="pausePreview" />
      <div class="play-overlay">
        <el-icon :size="40"><VideoPlay /></el-icon>
      </div>
      <el-button 
        class="locate-btn"
        size="small" 
        icon="Location"
        circle
        @click.stop="handleLocate" />
    </div>
    
    <!-- 房源信息 -->
    <div class="card-body">
      <h3>{{ data.roomType }} · {{ data.floor }}</h3>
      <div class="rent">¥{{ data.rent }} / 月</div>
      <div class="address" @click="goToLandlord">
        📍 {{ data.address }}
      </div>
      
      <!-- 配套设施标签 -->
      <div class="amenities">
        <el-tag 
          v-for="item in data.amenities.slice(0, 4)"
          :key="item"
          size="small">
          {{ item }}
        </el-tag>
        <el-tag v-if="data.amenities.length > 4" size="small">
          +{{ data.amenities.length - 4 }}
        </el-tag>
      </div>
      
      <!-- 公共费用 -->
      <div class="fees">
        <span>💧 {{ data.water.type }}</span>
        <span>⚡ {{ formatElectricity(data.electricity) }}</span>
        <span>🏦 {{ data.deposit }}</span>
      </div>
      
      <!-- 房东信息 -->
      <div class="landlord-info">
        📞 {{ data.landlordPhone }} ({{ landlordTypeLabel }})
      </div>
      
      <!-- 操作按钮 -->
      <el-button type="primary" @click="viewDetail" block>
        查看详情并整理
      </el-button>
    </div>
  </el-card>
</template>

<script setup lang="ts">
import { computed, ref } from 'vue';
import { VideoPlay } from '@element-plus/icons-vue';
import type { PropertyViewItem } from '@/types';

const props = defineProps<{
  data: PropertyViewItem;
}>();

const emit = defineEmits<{
  viewDetail: [id: string];
  locate: [gps: GPS];
  viewLandlord: [id: string];
}>();

const videoUrl = computed(() => props.data.videos[0]?.url || '');
const videoPoster = computed(() => props.data.videos[0]?.poster || '');

const viewDetail = () => emit('viewDetail', props.data.propertyId);
const handleLocate = () => emit('locate', props.data.gps);
const goToLandlord = () => emit('viewLandlord', props.data.landlordId);

// ... 其他逻辑
</script>
```

**PropertyDetailPage.vue 伪代码**：

```vue
<template>
  <el-dialog 
    v-model="visible"
    :title="`房源详情 - ${property.roomType} · ${landlord.address}`"
    width="90%"
    fullscreen
    destroy-on-close>
    <div class="detail-container">
      <!-- 左侧：视频播放器 -->
      <div class="video-section">
        <VideoPlayer 
          :videos="property.videos"
          v-model:current="currentVideoIndex" />
      </div>
      
      <!-- 右侧：表单 -->
      <div class="form-section">
        <el-form :model="formData" label-width="100px">
          <el-divider content-position="left">🏠 房源基本信息</el-divider>
          
          <el-form-item label="房型">
            <el-select v-model="formData.roomType">
              <el-option label="单间" value="单间" />
              <el-option label="一房一厅" value="一房一厅" />
              <!-- ... -->
            </el-select>
          </el-form-item>
          
          <el-form-item label="租金">
            <el-input-number v-model="formData.rent" :min="0" />
            <span class="unit">元/月</span>
          </el-form-item>
          
          <el-form-item label="楼层">
            <el-input v-model="formData.floor" placeholder="如：3楼" />
          </el-form-item>
          
          <el-form-item label="是否可租">
            <el-switch v-model="formData.available" />
          </el-form-item>
          
          <el-divider content-position="left">🛋️ 配套设施</el-divider>
          <el-form-item>
            <el-checkbox-group v-model="formData.amenities">
              <el-checkbox label="空调" />
              <el-checkbox label="洗衣机" />
              <el-checkbox label="冰箱" />
              <!-- ... -->
            </el-checkbox-group>
          </el-form-item>
          
          <el-divider content-position="left">💰 公共费用</el-divider>
          <el-alert 
            v-if="feesModified"
            type="warning" 
            :closable="false">
            修改公共费用会同步到房东信息，影响该房东下的所有房源
          </el-alert>
          
          <el-form-item label="水费">
            <el-select v-model="formData.water.type">
              <el-option label="民用水" value="civil" />
              <el-option label="5.0元/吨" value="5.0" />
              <!-- ... -->
            </el-select>
            <el-input-number 
              v-if="formData.water.type === 'custom'"
              v-model="formData.water.price" />
          </el-form-item>
          
          <el-form-item label="电费">
            <el-select v-model="formData.electricity.type">
              <el-option label="民用电" value="civil" />
              <el-option label="0.88元/度" value="0.88" />
              <!-- ... -->
            </el-select>
          </el-form-item>
          
          <el-form-item label="押金方式">
            <el-select v-model="formData.deposit">
              <el-option label="押一付一" value="押一付一" />
              <!-- ... -->
            </el-select>
          </el-form-item>
          
          <el-divider content-position="left">📝 房源备注</el-divider>
          <el-form-item>
            <el-input 
              v-model="formData.description"
              type="textarea"
              :rows="4"
              placeholder="补充说明..." />
          </el-form-item>
          
          <el-divider content-position="left">📞 房东信息</el-divider>
          <el-descriptions :column="1" border>
            <el-descriptions-item label="电话">
              <el-link @click="goToLandlord">{{ landlord.phoneNumbers[0] }}</el-link>
            </el-descriptions-item>
            <el-descriptions-item label="类型">{{ landlordTypeLabel }}</el-descriptions-item>
            <el-descriptions-item label="地址">{{ landlord.address }}</el-descriptions-item>
          </el-descriptions>
        </el-form>
      </div>
    </div>
    
    <template #footer>
      <el-button @click="handleCancel">取消</el-button>
      <el-button 
        type="primary" 
        :disabled="!hasChanges"
        :loading="saving"
        @click="handleSave">
        保存修改
      </el-button>
    </template>
  </el-dialog>
</template>

<script setup lang="ts">
import { ref, computed, watch } from 'vue';
import { usePropertyStore } from '@/stores/property';
import VideoPlayer from '@/components/VideoPlayer.vue';

const props = defineProps<{
  propertyId: string;
}>();

const visible = ref(true);
const propertyStore = usePropertyStore();
const currentVideoIndex = ref(0);
const saving = ref(false);

// 加载房源和房东数据
const property = computed(() => propertyStore.getPropertyById(props.propertyId));
const landlord = computed(() => propertyStore.getLandlordById(property.value.landlordId));

// 表单数据（深拷贝，避免直接修改原数据）
const formData = ref(JSON.parse(JSON.stringify(property.value)));

// 检测是否有修改
const hasChanges = computed(() => {
  return JSON.stringify(formData.value) !== JSON.stringify(property.value);
});

// 检测公共费用是否被修改
const feesModified = computed(() => {
  return formData.value.water !== property.value.water ||
         formData.value.electricity !== property.value.electricity ||
         formData.value.deposit !== property.value.deposit;
});

// 保存逻辑
const handleSave = async () => {
  saving.value = true;
  try {
    // 更新房源信息
    await propertyStore.updateProperty(props.propertyId, formData.value);
    
    // 如果公共费用有修改，同步到房东
    if (feesModified.value) {
      await propertyStore.updateLandlordCommonFees(landlord.value.id, {
        water: formData.value.water,
        electricity: formData.value.electricity,
        deposit: formData.value.deposit,
      });
    }
    
    ElMessage.success('保存成功');
    visible.value = false;
  } catch (error) {
    ElMessage.error('保存失败');
  } finally {
    saving.value = false;
  }
};

const handleCancel = () => {
  if (hasChanges.value) {
    ElMessageBox.confirm('有未保存的修改，确定要关闭吗？').then(() => {
      visible.value = false;
    });
  } else {
    visible.value = false;
  }
};
</script>

<style scoped>
.detail-container {
  display: flex;
  gap: 24px;
  height: 70vh;
}

.video-section {
  flex: 0 0 40%;
  display: flex;
  flex-direction: column;
}

.form-section {
  flex: 1;
  overflow-y: auto;
  padding-right: 16px;
}
</style>
```

---

## 3. 开发计划

### 3.1 任务拆解

#### Phase 1: 核心架构重构（预计2-3天）
- [ ] **MainView 主视图**：创建左右分栏布局 + Toolbar 切换
- [ ] **LandlordList 组件**：从 App.vue 抽离房东列表为独立组件
- [ ] **PropertyList 组件**：创建房源列表组件（垂直滚动，单列布局）
- [ ] **数据转换层**：实现 `transformToPropertyView` 函数，扁平化房源数据
- [ ] **Store 状态管理**：新增 `viewMode`、`flattenedProperties`、`filteredProperties`

#### Phase 2: 地图视图增强（预计2-3天）
- [ ] **MapView 增强**：支持 viewMode 切换，渲染不同类型的标记
- [ ] **数字徽章标记**：按 GPS 分组房源，显示房源数量
- [ ] **PropertyInfoWindow 组件**：创建房源 InfoWindow（视频缩略图列表）
- [ ] **定位功能**：实现 `locateToMarker` 方法，支持列表点击定位到地图
- [ ] **标记交互**：点击标记打开 InfoWindow，点击缩略图打开详情页

#### Phase 3: 筛选与联动（预计1-2天）
- [ ] **PropertyFilter 组件**：筛选器UI（位于左侧列表顶部）
- [ ] **筛选逻辑**：在 Store 中实现 `filteredProperties` 计算属性
- [ ] **地图联动**：筛选时地图标记同步更新，数字徽章数量也更新

#### Phase 4: 房源详情页与快速整理（预计2-3天）
- [ ] **PropertyDetailPage 组件**：左右分栏布局（左视频右表单）
- [ ] **表单直接编辑模式**：所有字段可编辑，无需点击"编辑"按钮
- [ ] **公共费用同步逻辑**：修改水电费时提示并同步到房东
- [ ] **表单验证**：租金必填、房型必选等
- [ ] **数据更新**：调用 Store 的 `updateProperty` 和 `updateLandlordCommonFees` 方法
- [ ] **底部保存按钮**：检测修改状态，显示保存提示

#### Phase 5: 优化与增强（预计1-2天）
- [ ] **视频懒加载**：卡片中视频缩略图懒加载，优化性能
- [ ] **视频预加载**：鼠标悬停卡片时预加载视频，提升详情页打开速度
- [ ] **键盘快捷键**：详情页中支持方向键切换视频、空格播放/暂停
- [ ] **地图性能优化**：大量标记时使用聚合（MarkerCluster）
- [ ] **卡片高亮动画**：点击定位按钮后，卡片添加高亮边框动画
- [ ] **统计信息**：显示筛选结果数量、平均租金等
- [ ] **未保存提示**：关闭详情页时检测未保存修改

### 3.2 数据流与状态管理

#### 3.2.1 关键状态

```typescript
// stores/property.ts
export const usePropertyStore = defineStore('property', () => {
  // ========== 核心状态 ==========
  const viewMode = ref<'landlord' | 'property'>('landlord'); // 视图模式
  const landlords = ref<Landlord[]>([]); // 房东列表
  
  // ========== 房源相关 ==========
  const propertyFilters = ref<PropertyFilterOptions>({}); // 房源筛选条件
  
  // 扁平化房源列表（从房东列表中提取所有房源）
  const flattenedProperties = computed(() => {
    const items: PropertyViewItem[] = [];
    landlords.value.forEach(landlord => {
      landlord.properties.forEach(property => {
        items.push({
          ...property,
          landlordId: landlord.id,
          landlordPhone: landlord.phoneNumbers[0],
          landlordType: landlord.landlordType,
          address: landlord.address,
          gps: landlord.gps,
          water: landlord.commonFees.water,
          electricity: landlord.commonFees.electricity,
          deposit: landlord.deposit,
        });
      });
    });
    return items;
  });
  
  // 筛选后的房源列表
  const filteredProperties = computed(() => {
    let result = flattenedProperties.value;
    
    if (propertyFilters.value.roomTypes?.length) {
      result = result.filter(p => 
        propertyFilters.value.roomTypes!.includes(p.roomType)
      );
    }
    
    if (propertyFilters.value.rentRange) {
      const [min, max] = propertyFilters.value.rentRange;
      result = result.filter(p => 
        p.rent && p.rent >= min && p.rent <= max
      );
    }
    
    // ... 其他筛选条件
    
    return result;
  });
  
  // 按 GPS 分组的房源（用于地图标记）
  const groupedPropertiesByGps = computed(() => {
    const groups = new Map<string, PropertyViewItem[]>();
    
    filteredProperties.value.forEach(property => {
      if (!property.gps) return;
      
      const key = `${property.gps.lng},${property.gps.lat}`;
      if (!groups.has(key)) {
        groups.set(key, []);
      }
      groups.get(key)!.push(property);
    });
    
    return Array.from(groups.entries()).map(([key, properties]) => ({
      gps: properties[0].gps,
      properties,
      count: properties.length
    }));
  });
  
  return {
    viewMode,
    landlords,
    propertyFilters,
    flattenedProperties,
    filteredProperties,
    groupedPropertiesByGps,
  };
});
```

#### 3.2.2 数据流示意图

```
用户操作                Store 状态变化                UI 响应
────────────────────────────────────────────────────────────
点击 Toolbar          →  viewMode: 'property'     →  左侧：LandlordList 卸载
"房源视图"                                            PropertyList 挂载
                                                    右侧：MapView 重新渲染
                                                         标记变为数字徽章

修改筛选条件          →  propertyFilters 更新     →  filteredProperties 自动更新
点击"应用"               (响应式计算)                左侧：列表更新
                                                    右侧：地图标记更新

点击卡片"定位"        →  调用 MapView.locateToMarker()
                         传入 gps 坐标            →  地图平滑移动到目标位置
                                                    打开 InfoWindow
                                                    卡片高亮显示

点击 InfoWindow       →  触发 openPropertyDetail(id)
中的视频缩略图            加载房源数据             →  打开详情页对话框
                                                    左侧播放视频
                                                    右侧显示表单

修改详情页信息        →  formData 本地状态         →  hasChanges = true
                                                    保存按钮高亮

点击"保存"            →  updateProperty(id, data)  →  更新 Store 中的数据
                         updateLandlordCommonFees()   关闭对话框
                         (如果修改了公共费用)         显示成功提示
```

### 3.3 技术风险评估

| 风险项 | 可能性 | 影响 | 应对方案 |
|-------|-------|------|---------|
| 大量数据渲染卡顿 | 中 | 高 | 使用虚拟滚动/分页加载 |
| 照片加载慢 | 高 | 中 | 懒加载 + 缩略图生成 |
| 筛选条件复杂度高 | 低 | 中 | 使用 computed 属性，避免重复计算 |
| 移动端适配 | 中 | 中 | 响应式网格布局 + 触摸优化 |

---

## 4. 用户体验优化

### 4.1 快捷操作

#### 4.1.1 批量操作
```
[ ] 选择多个房源 → [ 批量标记已租 ] [ 批量修改水费 ]
```

#### 4.1.2 排序功能
```
排序：[ 租金↑ ] [ 租金↓ ] [ 最新发布 ] [ 房型 ]
```

#### 4.1.3 视图切换
```
布局：[ 卡片视图 ] [ 列表视图 ] [ 紧凑视图 ]
```

### 4.2 信息密度平衡

**设计原则**：
- **卡片视图**（默认）：信息丰富，适合详细对比
- **列表视图**（可选）：信息精简，适合快速扫描
- **紧凑视图**（可选）：一屏显示更多，适合大数据量

### 4.3 空状态处理

```
┌────────────────────────────┐
│    📦                       │
│    暂无房源数据             │
│    请先录入房东信息          │
│    [ 去录入 ]               │
└────────────────────────────┘
```

```
┌────────────────────────────┐
│    🔍                       │
│    没有符合条件的房源        │
│    试试调整筛选条件          │
│    [ 重置筛选 ]             │
└────────────────────────────┘
```

---

## 5. 与现有功能的集成

### 5.1 导航集成

**方案1：顶部Tab切换**（推荐）

```vue
<el-tabs v-model="activeTab" @tab-click="handleTabChange">
  <el-tab-pane label="房东视图" name="landlord">
    <!-- 当前的房东列表 -->
  </el-tab-pane>
  <el-tab-pane label="房源视图" name="property">
    <PropertyView />
  </el-tab-pane>
  <el-tab-pane label="地图视图" name="map">
    <MapView />
  </el-tab-pane>
</el-tabs>
```

**方案2：独立路由**

```typescript
// router/index.ts
{
  path: '/landlords',
  component: LandlordView,
},
{
  path: '/properties',
  component: PropertyView,
},
{
  path: '/map',
  component: MapView,
}
```

### 5.2 数据联动

#### 场景1：从房源视图跳转到房东详情
```typescript
// PropertyCard.vue
const goToLandlord = () => {
  propertyStore.propertyViewMode = 'landlord';
  propertyStore.focusedLandlordId = props.data.landlordId;
  propertyStore.currentLandlord = findLandlordById(props.data.landlordId);
};
```

#### 场景2：从房东详情跳转到房源视图
```typescript
// LandlordDetail.vue
const viewAllProperties = () => {
  propertyStore.propertyViewMode = 'property';
  propertyStore.propertyFilters = {
    landlordId: currentLandlord.value.id
  };
};
```

#### 场景3：从地图定位房源
```typescript
// MapView.vue 标记点击事件
const onMarkerClick = (landlordId: string) => {
  propertyStore.propertyViewMode = 'property';
  propertyStore.propertyFilters = {
    landlordId
  };
};
```

---

## 6. 移动端适配方案

### 6.1 响应式布局

```scss
// PropertyView.vue
.property-grid {
  display: grid;
  gap: 16px;
  
  // PC端：4列
  @media (min-width: 1200px) {
    grid-template-columns: repeat(4, 1fr);
  }
  
  // 平板：2列
  @media (min-width: 768px) and (max-width: 1199px) {
    grid-template-columns: repeat(2, 1fr);
  }
  
  // 手机：1列
  @media (max-width: 767px) {
    grid-template-columns: 1fr;
  }
}
```

### 6.2 移动端优化

- **筛选器**：改为底部弹出抽屉
- **卡片**：增大点击热区，优化触摸体验
- **编辑面板**：全屏显示，避免遮挡
- **图片查看**：支持手势缩放

---

## 7. 后续扩展方向

### 7.1 高级筛选
- [ ] 地图圈选：在地图上框选区域，自动筛选该区域内的房源
- [ ] 智能推荐：根据用户浏览历史推荐相似房源
- [ ] 保存筛选方案：常用筛选条件保存为快捷入口

### 7.2 数据分析
- [ ] 租金热力图：可视化不同区域的租金水平
- [ ] 趋势分析：统计录入的房源数量、平均租金变化
- [ ] 对比工具：多个房源并排对比

### 7.3 协作功能
- [ ] 分享功能：生成房源链接，分享给他人
- [ ] 评论系统：为房源添加备注和评论
- [ ] 看房记录：记录看房时间、印象评价

---

## 8. 总结

### 8.1 核心价值

此功能解决的核心问题：
1. ✅ **提高浏览效率**：从"房东→房源"两级导航变为"房源"一级直达
2. ✅ **视频优先展示**：房源以视频为主，列表和地图都能快速预览视频缩略图
3. ✅ **信息聚合展示**：房源基本信息 + 房东公共费用一览无余
4. ✅ **灵活筛选对比**：多维度筛选，列表和地图联动更新
5. ✅ **快速整理能力**：一边看视频一边修改信息，无需多次跳转
6. ✅ **地图深度集成**：列表可定位到地图，地图标记显示房源数量，点击打开视频缩略图

### 8.2 设计亮点

1. **左右分栏 + Toolbar 切换**：
   - 左侧列表（房东/房源可切换）+ 右侧固定地图
   - 一次查看两种信息，无需来回切换页面
   
2. **地图标记智能化**：
   - 房东视图：圆点标记 + 颜色区分类型
   - 房源视图：数字徽章标记 + 显示房源数量
   - InfoWindow 显示视频缩略图，点击直接打开详情页
   
3. **列表与地图联动**：
   - 列表点击定位 → 地图自动定位 + 打开 InfoWindow
   - 地图筛选 → 列表同步更新
   - 标记数量动态变化（筛选后自动更新）
   
4. **组件化架构**：
   - LandlordList、PropertyList 独立组件，易于维护
   - MapView 组件增强，支持多种视图模式
   - 无需修改现有数据结构，充分利用现有 `Landlord` 和 `RoomInfo` 结构
   
5. **性能优先**：
   - 虚拟滚动 + 懒加载
   - 地图标记聚合（大量数据时）
   - 视频缩略图按需加载

### 8.3 开发建议

- **先做减法**：第一版只实现卡片展示 + 基础筛选 + 编辑功能
- **用户测试**：快速上线 MVP，收集真实反馈后再迭代
- **性能监控**：关注大数据量场景下的加载速度和内存占用
- **移动优先**：考虑到租房场景可能在手机上使用，优先优化移动端体验

---

## 9. 附录

### 9.1 参考案例

- **链家APP**：房源卡片设计，信息密度平衡
- **贝壳找房**：筛选器交互，地图联动
- **Airbnb**：网格布局，图片懒加载

### 9.2 技术栈

- **UI框架**：Element Plus
- **虚拟滚动**：`vue-virtual-scroller` (已集成)
- **图片懒加载**：`IntersectionObserver` API
- **状态管理**：Pinia (已集成)

### 9.3 关键指标

| 指标 | 目标值 | 说明 |
|-----|-------|------|
| 首屏加载时间 | < 1s | 包含20条房源卡片 |
| 筛选响应时间 | < 300ms | 任意筛选条件组合 |
| 图片加载完成 | < 2s | 可见区域内的图片 |
| 内存占用 | < 100MB | 显示100条房源时 |

---

**文档结束**

如有疑问或需要补充，请随时提出！💡
