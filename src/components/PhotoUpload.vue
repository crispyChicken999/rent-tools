<template>
  <div class="photo-upload">
    <div class="upload-section">
      <!-- æ“ä½œè¯´æ˜ -->
      <el-collapse v-model="activeHelp" class="help-section">
        <el-collapse-item name="1">
          <template #title>
            <div class="help-title">
              <el-icon><QuestionFilled /></el-icon>
              <span>æ“ä½œè¯´æ˜</span>
            </div>
          </template>
          <div class="help-content">
            <div class="help-step">
              <h4>ğŸ“ ç¬¬ä¸€æ­¥ï¼šé€‰æ‹©ç…§ç‰‡æ–‡ä»¶å¤¹</h4>
              <p>
                ç‚¹å‡»"é€‰æ‹©ç…§ç‰‡æ–‡ä»¶å¤¹"æŒ‰é’®ï¼Œé€‰æ‹©å­˜æ”¾æ‹›ç§Ÿå¹¿å‘Šç…§ç‰‡çš„æ–‡ä»¶å¤¹ã€‚ç³»ç»Ÿä¼šè®°ä½è¿™ä¸ªæ–‡ä»¶å¤¹ï¼Œä¸‹æ¬¡æ‰“å¼€æ— éœ€é‡æ–°é€‰æ‹©ã€‚
              </p>
            </div>
            <div class="help-step">
              <h4>ğŸ” ç¬¬äºŒæ­¥ï¼šæ‰«ææ–‡ä»¶å¤¹</h4>
              <p>
                ç‚¹å‡»"æ‰«ææ–‡ä»¶å¤¹"æŒ‰é’®ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è¯»å–ç…§ç‰‡çš„GPSä¿¡æ¯ï¼Œå¹¶ä¸ºæ¯å¼ ç…§ç‰‡åˆ›å»ºæˆ¿ä¸œè®°å½•ã€‚
              </p>
            </div>
            <div class="help-step">
              <h4>âš¡ ç¬¬ä¸‰æ­¥ï¼šå¿«é€Ÿæ•´ç†</h4>
              <p>
                ç‚¹å‡»"å¿«é€Ÿæ•´ç†"æŒ‰é’®ï¼Œè¿›å…¥å¿«é€Ÿå½•å…¥æ¨¡å¼ã€‚å·¦ä¾§æŸ¥çœ‹ç…§ç‰‡ï¼Œå³ä¾§è¾“å…¥ç”µè¯å·ç ã€‚
              </p>
              <ul>
                <li><kbd>Enter</kbd> - ä¿å­˜å¹¶è·³è½¬åˆ°ä¸‹ä¸€ä¸ªæˆ¿ä¸œ</li>
                <li><kbd>Shift+Enter</kbd> - æ·»åŠ æ–°çš„ç”µè¯å·ç è¾“å…¥æ¡†</li>
                <li><kbd>â†‘/â†“</kbd> - åœ¨å¤šä¸ªç”µè¯è¾“å…¥æ¡†ä¹‹é—´åˆ‡æ¢</li>
                <li>
                  <kbd>â†/â†’</kbd> æˆ– <kbd>A/D</kbd> - åˆ‡æ¢ä¸Šä¸€ä¸ª/ä¸‹ä¸€ä¸ªæˆ¿ä¸œ
                </li>
                <li>
                  <kbd>+/-</kbd> -
                  å¾ªç¯åˆ‡æ¢å›¾ç‰‡ç¼©æ”¾æ¨¡å¼ï¼ˆæ­£å¸¸/ç«–å±æ”¾å¤§/æ¨ªå±æ”¾å¤§ï¼‰
                </li>
                <li><kbd>Delete</kbd> - åˆ é™¤å½“å‰æˆ¿ä¸œï¼ˆéœ€æŒ‰ä¸¤æ¬¡ç¡®è®¤ï¼‰</li>
              </ul>
            </div>
            <div class="help-step">
              <h4>ğŸ’¡ å°è´´å£«</h4>
              <ul>
                <li>
                  ç…§ç‰‡å¿…é¡»åŒ…å«GPSä¿¡æ¯æ‰èƒ½è‡ªåŠ¨å®šä½ï¼Œå»ºè®®ä½¿ç”¨æ‰‹æœºåŸç”Ÿç›¸æœºæ‹æ‘„
                </li>
                <li>
                  ç³»ç»Ÿä¸ä¼šå¤åˆ¶ç…§ç‰‡æ–‡ä»¶ï¼Œåªæ˜¯è®°å½•æ–‡ä»¶ä½ç½®ï¼Œè¯·å‹¿ç§»åŠ¨æˆ–åˆ é™¤åŸå§‹ç…§ç‰‡
                </li>
                <li>
                  å¦‚æœæˆ¿ä¸œæœ‰å¤šä¸ªç”µè¯å·ç ï¼Œå¯ä»¥ä½¿ç”¨
                  <kbd>Shift+Enter</kbd> æ·»åŠ å¤šä¸ªè¾“å…¥æ¡†
                </li>
                <li>ç‚¹å‡»ç»¿è‰²"ä¿å­˜"æŒ‰é’®å¯ä»¥ä¿å­˜å½“å‰æˆ¿ä¸œä¿¡æ¯è€Œä¸è·³è½¬</li>
              </ul>
            </div>
          </div>
        </el-collapse-item>
      </el-collapse>

      <div v-if="folderPath" class="current-folder">
        å½“å‰æ–‡ä»¶å¤¹ï¼š<el-tag type="success">{{ folderPath }}</el-tag>
      </div>
      <el-alert
        v-if="!isSupported"
        title="æµè§ˆå™¨ä¸æ”¯æŒ"
        type="warning"
        description="å½“å‰æµè§ˆå™¨ä¸æ”¯æŒ File System Access APIï¼Œè¯·ä½¿ç”¨ Chrome 86+ æˆ– Edge 86+"
        :closable="false"
        show-icon
      />

      <div v-else class="button-group">
        <!-- ç¬¬ä¸€è¡Œï¼šé€‰æ‹©æ–‡ä»¶å¤¹å’Œæ‰«ææŒ‰é’® -->
        <div class="button-row">
          <el-button
            id="btn-select-folder"
            type="primary"
            size="large"
            :icon="Folder"
            @click="selectFolder"
            :loading="scanning"
          >
            é€‰æ‹©ç…§ç‰‡æ–‡ä»¶å¤¹
          </el-button>

          <el-button
            id="btn-scan-folder"
            :disabled="!folderPath"
            type="success"
            size="large"
            :icon="Refresh"
            @click="scanFolder"
            :loading="scanning"
          >
            æ‰«ææ–‡ä»¶å¤¹
          </el-button>
        </div>

        <el-button
          id="btn-fast-origanize"
          type="warning"
          size="large"
          :icon="Edit"
          :disabled="!folderPath"
          :loading="scanning"
          @click="startQuickOrganize"
        >
          å¿«é€Ÿæ•´ç†
        </el-button>

        <el-button
          id="btn-batch-scan-phone-location"
          type="success"
          size="large"
          :icon="Location"
          :loading="scanning"
          @click="batchRecognizeLocations"
        >
          æ‰¹é‡è¯†åˆ«æ‰‹æœºå·ç å½’å±åœ°
        </el-button>

        <el-button
          id="btn-clear-data"
          type="danger"
          size="large"
          :icon="Delete"
          @click="handleClearData"
          :loading="scanning"
        >
          æ¸…ç©ºæ‰€æœ‰æ•°æ®
        </el-button>
      </div>

      <el-progress
        v-if="scanning"
        :percentage="progress"
        :format="formatProgress"
        style="margin-top: 20px"
      />

      <div v-if="scanResult" class="scan-result">
        <el-descriptions :column="2" border>
          <el-descriptions-item label="æ€»æ–‡ä»¶æ•°">
            {{ scanResult.total }}
          </el-descriptions-item>
          <el-descriptions-item label="æˆåŠŸå¯¼å…¥">
            {{ scanResult.success }}
          </el-descriptions-item>
          <el-descriptions-item label="å¤±è´¥æ•°">
            {{ scanResult.failed }}
          </el-descriptions-item>
          <el-descriptions-item label="ç”¨æ—¶">
            {{ scanResult.duration }}ç§’
          </el-descriptions-item>
        </el-descriptions>
      </div>
    </div>

    <!-- æ‰¹é‡è¯†åˆ«æ—¥å¿—å¼¹çª— -->
    <el-dialog
      v-model="showBatchDialog"
      title="æ‰¹é‡è¯†åˆ«å½’å±åœ°"
      width="650px"
      :close-on-click-modal="false"
      :close-on-press-escape="!scanning"
      :show-close="!scanning"
    >
      <div class="batch-log-container">
        <!-- è¿›åº¦æ¡ -->
        <div v-if="scanning" class="batch-status">
          <el-progress
            :percentage="progress"
            :format="formatProgress"
            style="margin-bottom: 16px"
          />
          <p style="text-align: center; color: #909399; margin-bottom: 16px">
            æ­£åœ¨è¯†åˆ«ä¸­ï¼Œè¯·å‹¿å…³é—­...
          </p>
        </div>

        <!-- æ±‡æ€»ä¿¡æ¯ -->
        <div v-if="batchSummary" class="batch-summary">
          <el-descriptions :column="4" border size="small">
            <el-descriptions-item label="æ€»è®¡">
              <span
                class="clickable-stat"
                :class="{ active: batchLogFilter === 'all' }"
                @click="toggleBatchLogFilter('all')"
                title="ç‚¹å‡»æ˜¾ç¤ºå…¨éƒ¨"
              >
                {{ batchSummary.total }}
              </span>
            </el-descriptions-item>
            <el-descriptions-item label="æˆåŠŸ">
              <span
                class="clickable-stat success"
                :class="{ active: batchLogFilter === 'success' }"
                @click="toggleBatchLogFilter('success')"
                title="ç‚¹å‡»ç­›é€‰æˆåŠŸé¡¹"
              >
                {{ batchSummary.success }}
              </span>
            </el-descriptions-item>
            <el-descriptions-item label="å¤±è´¥">
              <span
                class="clickable-stat error"
                :class="{ active: batchLogFilter === 'error' }"
                @click="toggleBatchLogFilter('error')"
                title="ç‚¹å‡»ç­›é€‰å¤±è´¥é¡¹"
              >
                {{ batchSummary.failed }}
              </span>
            </el-descriptions-item>
            <el-descriptions-item label="è€—æ—¶">
              {{ batchSummary.duration }}s
            </el-descriptions-item>
          </el-descriptions>
          <p class="filter-hint">
            ğŸ’¡ ç‚¹å‡»æ•°å­—å¯ç­›é€‰æ—¥å¿—
            <span v-if="batchLogFilter !== 'all'" style="margin-left: 8px">
              ï¼ˆå½“å‰ï¼š{{
                batchLogFilter === "success" ? "æˆåŠŸ" : "å¤±è´¥"
              }}ï¼Œå†æ¬¡ç‚¹å‡»å–æ¶ˆç­›é€‰ï¼‰
            </span>
          </p>
          <el-alert
            v-if="batchSummary.interrupted"
            title="è¯†åˆ«å·²è¢«ä¸­æ–­"
            type="warning"
            :closable="false"
            style="margin-top: 8px"
          />
        </div>

        <!-- æ—¥å¿—åˆ—è¡¨ -->
        <div
          class="batch-log-list"
          style="max-height: 300px; overflow-y: auto; margin-top: 12px"
        >
          <div
            v-for="(log, index) in filteredBatchLogs"
            :key="index"
            class="batch-log-item"
            :class="log.status"
          >
            <span class="phone">{{ log.phone }}</span>
            <span class="arrow">â†’</span>
            <span v-if="log.status === 'success'" class="location">{{
              log.location
            }}</span>
            <span v-else class="error">{{ log.message || "å¤±è´¥" }}</span>
          </div>
          <el-empty
            v-if="filteredBatchLogs.length === 0 && !scanning"
            :description="
              batchLogFilter !== 'all' ? 'æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„è®°å½•' : 'æš‚æ— è®°å½•'
            "
          />
          <el-empty
            v-if="batchLogs.length === 0 && scanning"
            description="ç­‰å¾…è¯†åˆ«..."
          />
        </div>
      </div>
      <template #footer>
        <el-button
          v-if="scanning"
          type="danger"
          @click="cancelBatchRecognize"
          :disabled="batchCancelled"
        >
          {{ batchCancelled ? "æ­£åœ¨ä¸­æ–­..." : "ä¸­æ–­è¯†åˆ«" }}
        </el-button>
        <el-button
          v-if="!scanning"
          type="primary"
          @click="showBatchDialog = false"
        >
          å…³é—­
        </el-button>
      </template>
    </el-dialog>

    <!-- å¿«é€Ÿæ•´ç†å¼¹çª— -->
    <el-dialog
      v-model="showQuickOrganize"
      title="å¿«é€Ÿæ•´ç†æˆ¿ä¸œä¿¡æ¯ (å¿«æ·é”®: â†/â†’/A/D åˆ‡æ¢, +/- å¾ªç¯ç¼©æ”¾, Delete åˆ é™¤, Enter ä¿å­˜)"
      fullscreen
      :show-close="true"
      @opened="onQuickOrganizeOpened"
      @closed="closeQuickOrganize"
      class="quick-organize-dialog"
    >
      <div
        class="organize-container"
        v-if="organizeLandlord"
        @keydown="handleOrganizeKeydown"
        tabindex="0"
        ref="containerRef"
        style="outline: none; height: 100%; display: flex"
      >
        <div class="left-panel">
          <el-carousel
            trigger="click"
            height="80vh"
            :autoplay="false"
            indicator-position="outside"
            v-if="currentImageUrls.length > 0"
          >
            <el-carousel-item
              v-for="(url, index) in currentImageUrls"
              :key="index"
            >
              <div
                class="image-wrapper"
                :class="{
                  'zoom-portrait-large': imageZoomMode === 1,
                  'zoom-landscape-large': imageZoomMode === 2,
                }"
                :data-zoom-mode="imageZoomMode"
                @click="() => toggleImageZoom('forward')"
              >
                <img :src="url" class="carousel-image" />
              </div>
            </el-carousel-item>
          </el-carousel>
          <div v-else class="no-image">æ— ç…§ç‰‡</div>
          <div class="photo-info">{{ currentImageUrls.length }} å¼ ç…§ç‰‡</div>
          <!-- ç¼©æ”¾æ¨¡å¼æç¤º -->
          <div class="zoom-mode-indicator" v-if="imageZoomMode > 0">
            {{ zoomModeText }}
          </div>
        </div>

        <div class="right-panel">
          <div class="info-card">
            <h3>
              æˆ¿ä¸œ {{ organizeIndex + 1 }} /
              {{ propertyStore.landlords.length }}
            </h3>
            <p class="landlord-id">ID: {{ organizeLandlord.id }}</p>

            <div class="form-section">
              <div
                v-for="(_phone, index) in currentPhones"
                :key="index"
                class="phone-input-wrapper"
                style="margin-bottom: 10px"
              >
                <div style="display: flex; align-items: center; gap: 8px">
                  <el-input
                    :ref="(el:any) => (phoneInputRefs[index] = el)"
                    v-model="currentPhones[index][0]"
                    placeholder="è¾“å…¥ç”µè¯å·ç "
                    size="large"
                    @keydown.enter.exact.prevent="saveAndNext"
                    @keydown.shift.enter.prevent="addPhoneField"
                    @keydown.up.prevent="focusPrevInput(index)"
                    @keydown.down.prevent="focusNextInput(index)"
                    clearable
                    style="flex: 1"
                  >
                    <template #prepend>ç”µè¯ {{ index + 1 }}</template>
                  </el-input>
                  <el-tag
                    v-if="currentPhones[index][1]"
                    type="info"
                    size="small"
                    style="white-space: nowrap"
                  >
                    {{ currentPhones[index][1] }}
                  </el-tag>
                </div>
              </div>
              <div class="input-tip">
                <p>Enter ä¿å­˜ | Shift+Enter æ·»åŠ å·ç  | â†‘/â†“ åˆ‡æ¢è¾“å…¥æ¡†</p>
                <p>A/Dæˆ–å·¦å³ç®­å¤´ åˆ‡æ¢æˆ¿ä¸œ | +/- å¾ªç¯ç¼©æ”¾</p>
              </div>
              <div>
                <el-checkbox v-model="deleteWithImages">
                  åŒæ—¶åˆ é™¤å¯¹åº”çš„å›¾ç‰‡æ–‡ä»¶ï¼ˆå›¾ç‰‡ä¼šç§»åŠ¨åˆ°åŒç›®å½•ä¸‹çš„ .trash
                  æ–‡ä»¶å¤¹ä¸­ï¼‰
                </el-checkbox>
              </div>
            </div>

            <div class="actions">
              <el-button
                type="danger"
                size="large"
                @click="handleDeleteRequest"
                class="action-btn"
              >
                åˆ é™¤ (Delete) {{ deleteConfirmCount > 0 ? "å†æ¬¡ç¡®è®¤" : "" }}
              </el-button>

              <div class="nav-buttons">
                <el-button
                  size="large"
                  @click="prevLandlord"
                  :disabled="organizeIndex <= 0"
                >
                  ä¸Šä¸€ä¸ª (â†/A)
                </el-button>
                <el-button
                  type="success"
                  size="large"
                  @click="saveCurrentLandlord"
                  :icon="Check"
                >
                  ä¿å­˜
                </el-button>
                <el-button
                  type="primary"
                  size="large"
                  @click="nextLandlord"
                  :disabled="
                    organizeIndex >= propertyStore.landlords.length - 1
                  "
                >
                  ä¸‹ä¸€ä¸ª (â†’/D)
                </el-button>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div v-else class="empty-state">
        <el-empty description="æ²¡æœ‰æˆ¿ä¸œæ•°æ®" />
      </div>
    </el-dialog>

    <!-- åˆ é™¤ç¡®è®¤å¼¹çª— -->
  </div>
</template>

<script setup lang="ts">
import { ref, onMounted, computed, nextTick } from "vue";
import { ElMessage, ElMessageBox } from "element-plus";
import {
  Folder,
  Refresh,
  Delete,
  Edit,
  Check,
  QuestionFilled,
  Location,
} from "@element-plus/icons-vue";
import {
  isFileSystemAccessSupported,
  requestDirectoryAccess,
  getValidDirectoryHandle,
  scanDirectory,
  getFileByName,
} from "@/utils/fileSystem";
import { extractExif } from "@/utils/exif";
import { usePropertyStore } from "@/stores/property";
import { queryPhoneLocation } from "@/utils/phoneLocation";
import type { Photo } from "@/types";

const propertyStore = usePropertyStore();

const isSupported = ref(isFileSystemAccessSupported());
const folderPath = ref("");
const scanning = ref(false);
const progress = ref(0);
const currentFile = ref(0);
const totalFiles = ref(0);
const batchProgressText = ref(""); // æ‰¹é‡è¯†åˆ«è¿›åº¦æ–‡æœ¬
const activeHelp = ref<string[]>([]); // é»˜è®¤æŠ˜å å¸®åŠ©é¢æ¿

const scanResult = ref<{
  total: number;
  success: number;
  failed: number;
  duration: number;
} | null>(null);

const handleClearData = async () => {
  try {
    await ElMessageBox.confirm(
      "ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼",
      "è­¦å‘Š",
      {
        confirmButtonText: "ç¡®å®šæ¸…ç©º",
        cancelButtonText: "å–æ¶ˆ",
        type: "warning",
      }
    );

    scanning.value = true;
    await propertyStore.clearAllData();
    folderPath.value = "";
    scanResult.value = null;
    dirHandle = null;
    ElMessage.success("æ‰€æœ‰æ•°æ®å·²æ¸…ç©º");
  } catch (error) {
    if (error !== "cancel") {
      console.error("Clear data error:", error);
      ElMessage.error("æ¸…ç©ºæ•°æ®å¤±è´¥");
    }
  } finally {
    scanning.value = false;
  }
};

let dirHandle: FileSystemDirectoryHandle | null = null;

onMounted(async () => {
  // å°è¯•æ¢å¤å·²ä¿å­˜çš„æ–‡ä»¶å¤¹è®¿é—®æƒé™
  const savedHandle = await getValidDirectoryHandle();
  if (savedHandle) {
    dirHandle = savedHandle;
    folderPath.value = savedHandle.name;
  }
});

async function selectFolder() {
  try {
    // è¯·æ±‚è¯»å†™æƒé™
    const result = await requestDirectoryAccess(
      "userPhotosFolder",
      "readwrite"
    );
    dirHandle = result.handle;
    folderPath.value = result.displayPath;
    ElMessage.success("æ–‡ä»¶å¤¹è®¿é—®æƒé™å·²æˆäºˆï¼ˆåŒ…å«å†™å…¥æƒé™ï¼‰");
  } catch (error: any) {
    if (error.message.includes("å–æ¶ˆ")) {
      ElMessage.info("å·²å–æ¶ˆé€‰æ‹©");
    } else {
      ElMessage.error(`é€‰æ‹©æ–‡ä»¶å¤¹å¤±è´¥: ${error.message}`);
    }
  }
}

async function scanFolder() {
  if (!dirHandle) {
    ElMessage.warning("è¯·å…ˆé€‰æ‹©æ–‡ä»¶å¤¹");
    return;
  }

  scanning.value = true;
  scanResult.value = null;
  const startTime = Date.now();

  try {
    // æ‰«ææ–‡ä»¶
    const files = await scanDirectory(dirHandle, (current, total) => {
      currentFile.value = current;
      totalFiles.value = total;
      progress.value = Math.round((current / total) * 100);
    });

    let successCount = 0;
    let failedCount = 0;

    // å¤„ç†æ¯ä¸ªæ–‡ä»¶
    for (const fileEntry of files) {
      try {
        if (fileEntry.type === "image") {
          // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒæ–‡ä»¶åçš„ç…§ç‰‡
          const isDuplicate = propertyStore.landlords.some((l) =>
            l.photos.some((p) => p.fileName === fileEntry.name)
          );

          if (isDuplicate) {
            console.log(`è·³è¿‡é‡å¤æ–‡ä»¶: ${fileEntry.name}`);
            continue;
          }

          const file = await fileEntry.handle.getFile();
          const exifData = await extractExif(file);

          const photo: Photo = {
            id: `photo-${Date.now()}-${Math.random()
              .toString(36)
              .substr(2, 9)}`,
            fileName: fileEntry.name,
            folderId: "userPhotosFolder",
            captureTime: exifData.captureTime,
            gps: exifData.gps,
          };

          // è‡ªåŠ¨å»ºæ¡£
          await propertyStore.createLandlord({
            photos: [photo],
            gps: exifData.gps,
            captureTime: exifData.captureTime,
            folderId: "userPhotosFolder",
          });

          successCount++;
        }
      } catch (error) {
        console.error(`å¤„ç†æ–‡ä»¶å¤±è´¥ ${fileEntry.name}:`, error);
        failedCount++;
      }
    }

    const duration = ((Date.now() - startTime) / 1000).toFixed(2);

    scanResult.value = {
      total: files.length,
      success: successCount,
      failed: failedCount,
      duration: Number(duration),
    };

    ElMessage.success(`æ‰«æå®Œæˆï¼æˆåŠŸå¯¼å…¥ ${successCount} ä¸ªæ–‡ä»¶`);
  } catch (error: any) {
    ElMessage.error(`æ‰«æå¤±è´¥: ${error.message}`);
  } finally {
    scanning.value = false;
    progress.value = 0;
  }
}

// ========== æ‰¹é‡è¯†åˆ«å½’å±åœ°åŠŸèƒ½ ==========

interface BatchLogItem {
  phone: string;
  location: string;
  status: "success" | "error" | "skip";
  message?: string;
}

interface BatchSummary {
  total: number;
  success: number;
  failed: number;
  duration: number; // ç§’
  interrupted: boolean;
}

const batchLogs = ref<BatchLogItem[]>([]);
const showBatchDialog = ref(false);
const batchCancelled = ref(false); // ä¸­æ–­æ ‡è®°
const batchSummary = ref<BatchSummary | null>(null);
const batchLogFilter = ref<"all" | "success" | "error">("all"); // æ—¥å¿—ç­›é€‰

// è¿‡æ»¤åçš„æ—¥å¿—åˆ—è¡¨
const filteredBatchLogs = computed(() => {
  if (batchLogFilter.value === "all") {
    return batchLogs.value;
  }
  return batchLogs.value.filter((log) => log.status === batchLogFilter.value);
});

// åˆ‡æ¢ç­›é€‰
const toggleBatchLogFilter = (filter: "all" | "success" | "error") => {
  if (batchLogFilter.value === filter) {
    batchLogFilter.value = "all"; // å†æ¬¡ç‚¹å‡»å–æ¶ˆç­›é€‰
  } else {
    batchLogFilter.value = filter;
  }
};

const batchRecognizeLocations = async () => {
  const landlords = propertyStore.landlords;

  // ç»Ÿè®¡éœ€è¦è¯†åˆ«çš„ç”µè¯æ•°é‡
  let totalPhonesToProcess = 0;
  landlords.forEach((l) => {
    l.phoneNumbers.forEach(([phone, location]) => {
      if (phone && phone.trim() && !location) {
        totalPhonesToProcess++;
      }
    });
  });

  if (totalPhonesToProcess === 0) {
    ElMessage.info("æ‰€æœ‰ç”µè¯å·ç éƒ½å·²æœ‰å½’å±åœ°ä¿¡æ¯");
  }

  // ç»Ÿè®¡å·²æœ‰å½’å±åœ°çš„ç”µè¯æ•°é‡
  let phonesWithLocation = 0;
  landlords.forEach((l) => {
    l.phoneNumbers.forEach(([phone, location]) => {
      if (phone && phone.trim() && location) {
        phonesWithLocation++;
      }
    });
  });

  // æ˜¾ç¤ºé€‰é¡¹å¯¹è¯æ¡†
  let forceRerecognize = false;

  if (phonesWithLocation > 0) {
    // æœ‰å·²è¯†åˆ«çš„å·ç ï¼Œè®©ç”¨æˆ·é€‰æ‹©
    try {
      await ElMessageBox({
        title: "æ‰¹é‡è¯†åˆ«å½’å±åœ°",
        message: `å‘ç° ${totalPhonesToProcess} ä¸ªå¾…è¯†åˆ«å·ç ï¼Œ${phonesWithLocation} ä¸ªå·²æœ‰å½’å±åœ°ä¿¡æ¯ã€‚\n\nè¯·é€‰æ‹©è¯†åˆ«æ¨¡å¼~`,
        showCancelButton: true,
        confirmButtonText: "åªè¯†åˆ«æ–°å·ç ",
        cancelButtonText: "å…¨éƒ¨é‡æ–°è¯†åˆ«",
        distinguishCancelAndClose: true,
        showClose: true,
        type: "info",
        customClass: "batch-recognize-dialog",
      });
      // ç”¨æˆ·ç‚¹å‡»äº†"åªè¯†åˆ«æ–°å·ç "
      forceRerecognize = false;
    } catch (action) {
      if (action === "cancel") {
        // è¯¢é—®æ˜¯å¦è¦å…¨éƒ¨é‡æ–°è¯†åˆ«
        try {
          await ElMessageBox.confirm(
            `æ˜¯å¦é‡æ–°è¯†åˆ«æ‰€æœ‰ ${
              totalPhonesToProcess + phonesWithLocation
            } ä¸ªå·ç ï¼ˆåŒ…æ‹¬å·²æœ‰å½’å±åœ°çš„ï¼‰ï¼Ÿ`,
            "é‡æ–°è¯†åˆ«å…¨éƒ¨",
            {
              confirmButtonText: "å…¨éƒ¨é‡æ–°è¯†åˆ«",
              cancelButtonText: "å–æ¶ˆ",
              type: "warning",
            }
          );
          forceRerecognize = true;
          totalPhonesToProcess += phonesWithLocation;
        } catch {
          return;
        }
      } else {
        // ç”¨æˆ·å…³é—­äº†å¯¹è¯æ¡†
        return;
      }
    }
  } else {
    // æ²¡æœ‰å·²è¯†åˆ«çš„å·ç ï¼Œç›´æ¥ç¡®è®¤
    try {
      await ElMessageBox.confirm(
        `å°†ä¸º ${totalPhonesToProcess} ä¸ªç”µè¯å·ç è¯†åˆ«å½’å±åœ°ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ`,
        "æ‰¹é‡è¯†åˆ«å½’å±åœ°",
        {
          confirmButtonText: "å¼€å§‹è¯†åˆ«",
          cancelButtonText: "å–æ¶ˆ",
          type: "info",
        }
      );
    } catch {
      return;
    }
  }

  const startTime = Date.now();
  scanning.value = true;
  progress.value = 0;
  batchLogs.value = [];
  batchSummary.value = null;
  batchCancelled.value = false;
  batchLogFilter.value = "all"; // é‡ç½®ç­›é€‰
  showBatchDialog.value = true;
  batchProgressText.value = `0 / ${totalPhonesToProcess}`;

  let processedCount = 0;
  let successCount = 0;
  let failedCount = 0;
  let updatedLandlordCount = 0;

  try {
    for (const landlord of landlords) {
      // æ£€æŸ¥æ˜¯å¦ä¸­æ–­
      if (batchCancelled.value) {
        break;
      }

      const phones = landlord.phoneNumbers;
      // æ ¹æ® forceRerecognize å†³å®šæ˜¯å¦éœ€è¦æ›´æ–°
      const needsUpdate = phones.some(
        ([phone, location]) =>
          phone && phone.trim() && (forceRerecognize || !location)
      );

      if (needsUpdate) {
        // é€ä¸ªæŸ¥è¯¢ç”µè¯å·ç ï¼Œä»¥ä¾¿è®°å½•æ—¥å¿—
        const updatedPhones: [string, string][] = [];

        for (const [phone, existingLocation] of phones) {
          // å†æ¬¡æ£€æŸ¥æ˜¯å¦ä¸­æ–­
          if (batchCancelled.value) {
            // ä¿ç•™å‰©ä½™æœªå¤„ç†çš„ç”µè¯
            updatedPhones.push([phone, existingLocation]);
            continue;
          }

          // æ ¹æ® forceRerecognize å†³å®šæ˜¯å¦éœ€è¦è¯†åˆ«è¿™ä¸ªå·ç 
          const shouldProcess =
            phone && phone.trim() && (forceRerecognize || !existingLocation);

          if (shouldProcess) {
            try {
              const location = await queryPhoneLocation(phone);
              processedCount++;

              if (location) {
                successCount++;
                batchLogs.value.unshift({
                  phone,
                  location,
                  status: "success",
                });
                updatedPhones.push([phone, location]);
              } else {
                failedCount++;
                batchLogs.value.unshift({
                  phone,
                  location: "",
                  status: "error",
                  message: "æœªæ‰¾åˆ°å½’å±åœ°ä¿¡æ¯",
                });
                updatedPhones.push([phone, ""]);
              }
            } catch (error: any) {
              processedCount++;
              failedCount++;
              batchLogs.value.unshift({
                phone,
                location: "",
                status: "error",
                message: error.message || "æŸ¥è¯¢å¤±è´¥",
              });
              updatedPhones.push([phone, ""]);
            }

            // æ›´æ–°è¿›åº¦
            batchProgressText.value = `${processedCount} / ${totalPhonesToProcess}`;
            progress.value = Math.round(
              (processedCount / totalPhonesToProcess) * 100
            );

            // æ·»åŠ å°å»¶è¿Ÿé¿å…è¯·æ±‚è¿‡å¿«
            await new Promise((resolve) => setTimeout(resolve, 300));
          } else {
            // å·²æœ‰å½’å±åœ°æˆ–ç©ºå·ç ï¼Œä¿ç•™åŸå€¼
            updatedPhones.push([phone, existingLocation]);
          }
        }

        // ä¿å­˜åˆ°æ•°æ®åº“ (å³ä½¿è¢«ä¸­æ–­ä¹Ÿè¦ä¿å­˜å·²å¤„ç†çš„éƒ¨åˆ†)
        await propertyStore.updateLandlordData(landlord.id, {
          phoneNumbers: JSON.parse(JSON.stringify(updatedPhones)),
        });

        updatedLandlordCount++;
      }
    }

    const duration = (Date.now() - startTime) / 1000;

    // è®¾ç½®æ±‡æ€»ä¿¡æ¯
    batchSummary.value = {
      total: totalPhonesToProcess,
      success: successCount,
      failed: failedCount,
      duration: Math.round(duration * 10) / 10,
      interrupted: batchCancelled.value,
    };

    if (batchCancelled.value) {
      ElMessage.warning(`å·²ä¸­æ–­ï¼å·²å¤„ç† ${processedCount} ä¸ªç”µè¯å·ç `);
    } else {
      ElMessage.success(
        `å·²æ›´æ–° ${updatedLandlordCount} ä¸ªæˆ¿ä¸œçš„ ${successCount} ä¸ªç”µè¯å·ç å½’å±åœ°`
      );
    }
  } catch (error: any) {
    console.error("æ‰¹é‡è¯†åˆ«å½’å±åœ°å¤±è´¥:", error);
    ElMessage.error(`æ‰¹é‡è¯†åˆ«å¤±è´¥: ${error.message}`);
  } finally {
    scanning.value = false;
    progress.value = 0;
    batchProgressText.value = "";
  }
};

// ä¸­æ–­æ‰¹é‡è¯†åˆ«
const cancelBatchRecognize = () => {
  batchCancelled.value = true;
  ElMessage.info("æ­£åœ¨ä¸­æ–­ï¼Œè¯·ç¨å€™...");
};

// ========== å¿«é€Ÿæ•´ç†åŠŸèƒ½ ==========

const showQuickOrganize = ref(false);
const organizeIndex = ref(0);
const currentPhones = ref<[string, string][]>([["", ""]]); // [æ‰‹æœºå·, å½’å±åœ°][]
const deleteWithImages = ref(true);
const deleteConfirmCount = ref(0);
const currentImageUrls = ref<string[]>([]);
// å›¾ç‰‡ç¼©æ”¾æ¨¡å¼: 0=æ­£å¸¸å±•ç¤º, 1=ç«–å±æ”¾å¤§, 2=æ¨ªå±æ”¾å¤§
const imageZoomMode = ref(0);
const phoneInputRefs = ref<any[]>([]);
let loadingImagesVersion = 0;

const organizeLandlord = computed(() => {
  if (propertyStore.landlords.length === 0) return null;
  return propertyStore.landlords[organizeIndex.value];
});

// ç¼©æ”¾æ¨¡å¼æ–‡æœ¬æç¤º
const zoomModeText = computed(() => {
  switch (imageZoomMode.value) {
    case 1:
      return "ğŸ“ ç«–å±æ”¾å¤§æ¨¡å¼";
    case 2:
      return "ğŸ“ æ¨ªå±æ”¾å¤§æ¨¡å¼";
    default:
      return "";
  }
});

const loadImagesForCurrentLandlord = async () => {
  const myVersion = ++loadingImagesVersion;

  // é‡Šæ”¾æ—§çš„ URL
  currentImageUrls.value.forEach((url) => URL.revokeObjectURL(url));
  currentImageUrls.value = [];
  phoneInputRefs.value = [];

  if (!organizeLandlord.value) return;

  // è®¾ç½®å½“å‰ç”µè¯ (æ–°æ ¼å¼å·²ç»æ˜¯ [string, string][])
  if (organizeLandlord.value.phoneNumbers?.length) {
    currentPhones.value = organizeLandlord.value.phoneNumbers.map(
      (phone) => [...phone] as [string, string]
    );
  } else {
    currentPhones.value = [["", ""]];
  }
  deleteConfirmCount.value = 0;

  // ç¡®ä¿æœ‰æ–‡ä»¶å¤¹è®¿é—®æƒé™
  if (!dirHandle) {
    dirHandle = await getValidDirectoryHandle();
  }

  if (!dirHandle) return;

  const urls: string[] = [];
  // åªåŠ è½½å‰5å¼ å›¾ç‰‡ä»¥æé«˜æ€§èƒ½ï¼Œæˆ–è€…å…¨éƒ¨åŠ è½½
  for (const photo of organizeLandlord.value.photos) {
    if (myVersion !== loadingImagesVersion) return; // å¦‚æœæœ‰æ–°çš„åŠ è½½è¯·æ±‚ï¼Œä¸­æ­¢å½“å‰è¯·æ±‚
    try {
      const file = await getFileByName(dirHandle, photo.fileName);
      if (file) {
        urls.push(URL.createObjectURL(file));
      }
    } catch (e) {
      console.error("Load image error", e);
    }
  }

  if (myVersion === loadingImagesVersion) {
    currentImageUrls.value = urls;
  } else {
    // å¦‚æœç‰ˆæœ¬ä¸åŒ¹é…ï¼Œè¯´æ˜æœ‰æ–°çš„åŠ è½½è¯·æ±‚ï¼Œè¿™äº› URL åº”è¯¥è¢«é‡Šæ”¾ï¼ˆè™½ç„¶å®ƒä»¬è¿˜æ²¡è¢«èµ‹å€¼ç»™ currentImageUrlsï¼Œä½†å·²ç»åˆ›å»ºäº† Blob URLï¼‰
    urls.forEach((url) => URL.revokeObjectURL(url));
  }
};

const startQuickOrganize = async () => {
  if (propertyStore.landlords.length === 0) {
    ElMessage.warning("æ²¡æœ‰æˆ¿ä¸œæ•°æ®");
    return;
  }

  // æŸ¥æ‰¾ç¬¬ä¸€ä¸ªæ²¡æœ‰ç”µè¯å·ç çš„æˆ¿ä¸œ
  const nextIndex = propertyStore.landlords.findIndex(
    (l) => !l.phoneNumbers || l.phoneNumbers.length === 0
  );

  showQuickOrganize.value = true;
  organizeIndex.value = nextIndex !== -1 ? nextIndex : 0;

  if (nextIndex !== -1) {
    ElMessage.success(`å·²è‡ªåŠ¨è·³è½¬åˆ°ç¬¬ ${nextIndex + 1} ä¸ªå¾…æ•´ç†æˆ¿ä¸œ`);
  } else {
    ElMessage.info("æ‰€æœ‰æˆ¿ä¸œéƒ½å·²æ•´ç†ï¼Œä»å¤´å¼€å§‹æµè§ˆ");
  }

  await loadImagesForCurrentLandlord();
};

// å›¾ç‰‡ç¼©æ”¾åˆ‡æ¢å‡½æ•°ï¼Œæ”¯æŒæ­£å‘å’Œåå‘
const toggleImageZoom = (direction: "forward" | "backward" = "forward") => {
  if (direction === "forward") {
    // + é”®ï¼šæ­£å‘å¾ªç¯ 0 â†’ 1 â†’ 2 â†’ 0
    imageZoomMode.value = (imageZoomMode.value + 1) % 3;
  } else {
    // - é”®ï¼šåå‘å¾ªç¯ 0 â†’ 2 â†’ 1 â†’ 0
    imageZoomMode.value = (imageZoomMode.value - 1 + 3) % 3;
  }

  // ä½¿ç”¨åŒé‡ nextTick + requestAnimationFrame ç¡®ä¿ DOM å’Œ CSS æ ·å¼éƒ½å®Œå…¨æ›´æ–°
  nextTick(() => {
    nextTick(() => {
      // ä½¿ç”¨ requestAnimationFrame ç¡®ä¿æµè§ˆå™¨å®Œæˆé‡æ’å’Œé‡ç»˜
      requestAnimationFrame(() => {
        // åå‘åˆ‡æ¢æ—¶éœ€è¦ç­‰å¾… CSS transition åŠ¨ç”»å®Œæˆï¼Œæ­£å‘åˆ‡æ¢æ—¶ç«‹å³æ‰§è¡Œ
        const delay = direction === "backward" ? 350 : 0;

        setTimeout(() => {
          if (imageZoomMode.value > 0) {
            // æ”¾å¤§æ—¶æ»šåŠ¨åˆ°ä¸­é—´
            const wrappers = document.querySelectorAll(
              ".image-wrapper[data-zoom-mode]"
            );
            wrappers.forEach((wrapper) => {
              const img = wrapper.querySelector("img");
              if (img) {
                // ç­‰å¾…å›¾ç‰‡å®Œå…¨åŠ è½½åå†è®¡ç®—æ»šåŠ¨ä½ç½®
                if (img.complete) {
                  centerImage(wrapper as HTMLElement, img as HTMLImageElement);
                } else {
                  img.onload = () => {
                    centerImage(
                      wrapper as HTMLElement,
                      img as HTMLImageElement
                    );
                  };
                }
              }
            });
          }

          if (phoneInputRefs.value.length > 0) {
            phoneInputRefs.value[0]?.focus();
          }
        }, delay); // + é”®æ— å»¶è¿Ÿï¼Œ- é”®ç­‰å¾… 350ms
      });
    });
  });
};

// å±…ä¸­å›¾ç‰‡çš„è¾…åŠ©å‡½æ•°
const centerImage = (wrapper: HTMLElement, img: HTMLImageElement) => {
  // å‚ç›´å±…ä¸­
  wrapper.scrollTop = (img.scrollHeight - wrapper.clientHeight) / 2;
  // æ¨ªå‘å±…ä¸­
  wrapper.scrollLeft = (img.scrollWidth - wrapper.clientWidth) / 2;
};

const onQuickOrganizeOpened = () => {
  nextTick(() => {
    if (phoneInputRefs.value.length > 0) {
      phoneInputRefs.value[0]?.focus();
    }
  });
};

const closeQuickOrganize = () => {
  showQuickOrganize.value = false;
  currentImageUrls.value.forEach((url) => URL.revokeObjectURL(url));
  currentImageUrls.value = [];
};

const nextLandlord = () => {
  if (organizeIndex.value < propertyStore.landlords.length - 1) {
    organizeIndex.value++;
    imageZoomMode.value = 0;
    loadImagesForCurrentLandlord();
    nextTick(() => {
      if (phoneInputRefs.value.length > 0) {
        phoneInputRefs.value[0]?.focus();
      }
    });
  } else {
    ElMessage.info("å·²ç»æ˜¯æœ€åä¸€ä¸ªäº†");
  }
};

const prevLandlord = () => {
  if (organizeIndex.value > 0) {
    organizeIndex.value--;
    imageZoomMode.value = 0;
    loadImagesForCurrentLandlord();
    nextTick(() => {
      if (phoneInputRefs.value.length > 0) {
        phoneInputRefs.value[0]?.focus();
      }
    });
  }
};

const addPhoneField = () => {
  currentPhones.value.push(["", ""] as [string, string]);
  // ä½¿ç”¨åŒé‡ nextTick ç¡®ä¿ DOM å®Œå…¨æ›´æ–°åå†èšç„¦
  nextTick(() => {
    nextTick(() => {
      const inputs = phoneInputRefs.value;
      if (inputs && inputs.length > 0) {
        const lastInput = inputs[inputs.length - 1];
        if (lastInput) {
          // å¦‚æœæ˜¯ Element Plus çš„ input ç»„ä»¶ï¼Œéœ€è¦è®¿é—®å…¶å†…éƒ¨çš„ input å…ƒç´ 
          if (lastInput.$el) {
            const inputElement = lastInput.$el.querySelector("input");
            inputElement?.focus();
          } else {
            lastInput.focus();
          }
        }
      }
    });
  });
};

// èšç„¦åˆ°ä¸Šä¸€ä¸ªè¾“å…¥æ¡†
const focusPrevInput = (currentIndex: number) => {
  if (currentIndex > 0) {
    nextTick(() => {
      const inputs = phoneInputRefs.value;
      if (inputs && inputs[currentIndex - 1]) {
        const prevInput = inputs[currentIndex - 1];
        if (prevInput.$el) {
          const inputElement = prevInput.$el.querySelector("input");
          inputElement?.focus();
        } else {
          prevInput.focus();
        }
      }
    });
  }
};

// èšç„¦åˆ°ä¸‹ä¸€ä¸ªè¾“å…¥æ¡†
const focusNextInput = (currentIndex: number) => {
  if (currentIndex < currentPhones.value.length - 1) {
    nextTick(() => {
      const inputs = phoneInputRefs.value;
      if (inputs && inputs[currentIndex + 1]) {
        const nextInput = inputs[currentIndex + 1];
        if (nextInput.$el) {
          const inputElement = nextInput.$el.querySelector("input");
          inputElement?.focus();
        } else {
          nextInput.focus();
        }
      }
    });
  }
};

const saveAndNext = async () => {
  if (organizeLandlord.value) {
    // ä¿å­˜ç”µè¯ (è¿‡æ»¤æ‰ç©ºçš„ç”µè¯å·ç ï¼Œä¿ç•™å½’å±åœ°ä¿¡æ¯)
    // ä½¿ç”¨ JSON.parse/stringify ç¡®ä¿æ˜¯çº¯æ•°ç»„
    const validPhones: [string, string][] = JSON.parse(
      JSON.stringify(currentPhones.value.filter(([phone]) => phone.trim()))
    );

    if (
      validPhones.length > 0 ||
      organizeLandlord.value.phoneNumbers.length > 0
    ) {
      await propertyStore.updateLandlordData(organizeLandlord.value.id, {
        phoneNumbers: validPhones,
      });
      ElMessage.success("ä¿å­˜æˆåŠŸ");
    }

    // è‡ªåŠ¨è·³è½¬ä¸‹ä¸€ä¸ª
    if (organizeIndex.value < propertyStore.landlords.length - 1) {
      nextLandlord();
    } else {
      ElMessage.success("æ•´ç†å®Œæˆï¼");
    }
  }
};

// åªä¿å­˜å½“å‰æˆ¿ä¸œï¼Œä¸è·³è½¬
const saveCurrentLandlord = async () => {
  if (organizeLandlord.value) {
    // ä½¿ç”¨ JSON.parse/stringify ç¡®ä¿æ˜¯çº¯æ•°ç»„
    const validPhones: [string, string][] = JSON.parse(
      JSON.stringify(currentPhones.value.filter(([phone]) => phone.trim()))
    );

    if (
      validPhones.length > 0 ||
      organizeLandlord.value.phoneNumbers.length > 0
    ) {
      await propertyStore.updateLandlordData(organizeLandlord.value.id, {
        phoneNumbers: validPhones,
      });
      ElMessage.success("ä¿å­˜æˆåŠŸ");
    } else {
      ElMessage.warning("è¯·è‡³å°‘è¾“å…¥ä¸€ä¸ªç”µè¯å·ç ");
    }
  }
};

const handleDeleteRequest = async () => {
  deleteConfirmCount.value++;
  if (deleteConfirmCount.value >= 2) {
    if (organizeLandlord.value) {
      const idToDelete = organizeLandlord.value.id;
      await propertyStore.removeLandlord(idToDelete, deleteWithImages.value);
      ElMessage.success("å·²åˆ é™¤");
      deleteConfirmCount.value = 0;

      if (propertyStore.landlords.length === 0) {
        closeQuickOrganize();
      } else {
        if (organizeIndex.value >= propertyStore.landlords.length) {
          organizeIndex.value = propertyStore.landlords.length - 1;
        }
        // é‡æ–°åŠ è½½å½“å‰ï¼ˆæ–°çš„ï¼‰æˆ¿ä¸œ
        imageZoomMode.value = 0;
        loadImagesForCurrentLandlord();
        nextTick(() => {
          if (phoneInputRefs.value.length > 0) {
            phoneInputRefs.value[0]?.focus();
          }
        });
      }
    }
  } else {
    ElMessage.warning("å†æŒ‰ä¸€æ¬¡åˆ é™¤é”®ç¡®è®¤åˆ é™¤");
  }
};

const handleOrganizeKeydown = (e: KeyboardEvent) => {
  if (!showQuickOrganize.value) return;

  // Arrow Left/Right or A/D for navigation
  if (e.key === "ArrowRight" || e.key === "d" || e.key === "D") {
    e.preventDefault();
    nextLandlord();
  } else if (e.key === "ArrowLeft" || e.key === "a" || e.key === "A") {
    e.preventDefault();
    prevLandlord();
  } else if (e.key === "Delete") {
    e.preventDefault();
    handleDeleteRequest();
  } else if (e.key === "+" || e.key === "=") {
    // + é”®ï¼šæ­£å‘å¾ªç¯
    e.preventDefault();
    toggleImageZoom("forward");
  } else if (e.key === "-") {
    // - é”®ï¼šåå‘å¾ªç¯
    e.preventDefault();
    toggleImageZoom("backward");
  }
};

// Clean up unused code
// const handleDeleteDialogKeydown = ...
// watch(showDeleteDialog, ...
// onUnmounted(() => ...

function formatProgress(_percentage: number): string {
  // å¦‚æœæœ‰æ‰¹é‡è¯†åˆ«è¿›åº¦æ–‡æœ¬ï¼Œä¼˜å…ˆæ˜¾ç¤º
  if (batchProgressText.value) {
    return batchProgressText.value;
  }
  return `${currentFile.value} / ${totalFiles.value}`;
}
</script>

<style lang="scss" scoped>
.photo-upload {
  padding: 20px;
}

.card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.upload-section {
  display: flex;
  flex-direction: column;
  gap: 20px;
}

.current-folder {
  text-align: center;
  font-size: 14px;
  padding: 5px 0;
  display: flex;
  justify-content: center;
  align-items: center;
  border-radius: 4px;
  background-color: #f0f0f0;
  border: 1px solid #dcdfe6;
}

.help-section {
  margin-bottom: 15px;
  border: none;

  :deep(.el-collapse-item__header) {
    background-color: #f5f7fa;
    border: 1px solid #e4e7ed;
    border-radius: 4px;
    padding: 0 12px;
    font-weight: 500;
    height: 40px;
    line-height: 40px;
  }

  :deep(.el-collapse-item__wrap) {
    border: none;
  }

  :deep(.el-collapse-item__content) {
    padding: 12px;
    background-color: #fafafa;
    border: 1px solid #e4e7ed;
    border-top: none;
    border-radius: 0 0 4px 4px;
  }
}

.help-title {
  display: flex;
  align-items: center;
  gap: 6px;
  color: #409eff;

  .el-icon {
    font-size: 16px;
  }
}

.help-content {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.help-step {
  h4 {
    margin: 0 0 6px 0;
    color: #303133;
    font-size: 14px;
    font-weight: 600;
  }

  p {
    margin: 0 0 6px 0;
    color: #606266;
    line-height: 1.5;
    font-size: 13px;
  }

  ul {
    margin: 0;
    padding-left: 18px;
    color: #606266;
    line-height: 1.6;
    font-size: 13px;

    li {
      margin-bottom: 3px;
    }
  }

  kbd {
    display: inline-block;
    padding: 1px 5px;
    font-size: 11px;
    font-family: "Courier New", monospace;
    color: #303133;
    background-color: #f4f4f5;
    border: 1px solid #d3d4d6;
    border-radius: 3px;
    box-shadow: 0 1px 0 rgba(0, 0, 0, 0.1);
    white-space: nowrap;
  }
}

.button-group {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.button-row {
  display: flex;
  gap: 10px;
  margin-bottom: 20px;
  .el-button {
    flex: 1;
  }
}

.el-button {
  margin: 0;
}

.scan-result {
  margin-top: 20px;
}

:deep(.quick-organize-dialog .el-dialog__body) {
  padding: 0;
  height: calc(100vh - 87px);
  overflow: hidden;
}

.organize-container {
  display: flex;
}

.left-panel {
  flex: 2;
  background: #000;
  display: flex;
  flex-direction: column;
  justify-content: center;
  position: relative;
}

.carousel-image {
  max-width: 100%;
  max-height: 100%;
  object-fit: contain;
  transition: all 0.3s ease;
}

.image-wrapper {
  width: 100%;
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: zoom-in;
  overflow: hidden;
}

/* ç«–å±æ”¾å¤§æ¨¡å¼ */
.image-wrapper.zoom-portrait-large {
  display: block;
  overflow-y: auto;
  overflow-x: hidden;
}
.image-wrapper.zoom-portrait-large .carousel-image {
  width: 100%;
  height: auto;
  max-width: none;
  max-height: none;
  object-fit: unset;
}

/* æ¨ªå±æ”¾å¤§æ¨¡å¼ */
.image-wrapper.zoom-landscape-large {
  display: block;
  overflow-y: auto;
  overflow-x: auto;
}
.image-wrapper.zoom-landscape-large .carousel-image {
  width: auto;
  height: 100%;
  max-width: none;
  max-height: none;
  object-fit: unset;
  margin: 0 auto;
  display: block;
}

.photo-info {
  position: absolute;
  bottom: 20px;
  right: 20px;
  color: white;
  background: rgba(0, 0, 0, 0.5);
  padding: 5px 10px;
  border-radius: 4px;
}

.zoom-mode-indicator {
  position: absolute;
  bottom: 20px;
  left: 20px;
  color: white;
  background: rgba(67, 160, 71, 0.8);
  padding: 8px 15px;
  border-radius: 4px;
  font-size: 14px;
  font-weight: 500;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
  animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.right-panel {
  flex: 1;
  padding: 20px;
  background: #f5f7fa;
  display: flex;
  flex-direction: column;
  justify-content: center;
}

.info-card {
  background: white;
  padding: 30px;
  border-radius: 8px;
  box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1);
}

.landlord-id {
  color: #909399;
  font-size: 12px;
  margin-bottom: 20px;
}

.form-section {
  margin: 30px 0;
}

.input-tip {
  font-size: 12px;
  color: #909399;
  margin: 10px 0;
  display: flex;
  flex-direction: column;
  gap: 5px;
}

.actions {
  display: flex;
  flex-direction: column;
  gap: 20px;
}

.nav-buttons {
  display: flex;
  gap: 10px;
}

.nav-buttons .el-button {
  flex: 1;
}

.action-btn {
  width: 100%;
}

.no-image {
  color: white;
  text-align: center;
}

.empty-state {
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100%;
}

/* æ‰¹é‡è¯†åˆ«æ—¥å¿—æ ·å¼ */
.batch-log-container {
  min-height: 200px;
}

.batch-summary {
  margin-bottom: 8px;
  padding-bottom: 8px;
  border-bottom: 1px solid #ebeef5;
}

.filter-hint {
  margin: 8px 0 0;
  font-size: 12px;
  color: #909399;
}

.clickable-stat {
  cursor: pointer;
  padding: 2px 8px;
  border-radius: 4px;
  font-weight: 600;
  transition: all 0.2s;

  &:hover {
    background: #f5f7fa;
  }

  &.success {
    color: #67c23a;
    &:hover,
    &.active {
      background: #f0f9eb;
    }
  }

  &.error {
    color: #f56c6c;
    &:hover,
    &.active {
      background: #fef0f0;
    }
  }

  &.active {
    background: #ecf5ff;
    box-shadow: 0 0 0 2px #409eff40;
  }
}

.batch-log-item {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 12px;
  border-radius: 4px;
  margin-bottom: 6px;
  font-family: monospace;
  font-size: 13px;

  &.success {
    background: #f0f9eb;
    border: 1px solid #e1f3d8;
  }

  &.error {
    background: #fef0f0;
    border: 1px solid #fde2e2;
  }

  .phone {
    font-weight: 600;
    color: #303133;
    min-width: 120px;
  }

  .arrow {
    color: #909399;
  }

  .location {
    color: #67c23a;
    font-weight: 500;
  }

  .error {
    color: #f56c6c;
  }
}
</style>
